<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸‰ì—¬ëª…ì„¸ì„œ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { text-align: center; }
        .payroll-container { max-width: 600px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 10px; background: white; }
        .input-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .input-container label { flex: 1; text-align: left; }
        .input-container input { flex: 2; padding: 5px; }
        .payroll-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .payroll-table th, .payroll-table td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        .signature { margin-top: 20px; font-size: 24px; font-weight: bold; } /* ì§ì¸ ìŠ¤íƒ€ì¼ */
        
        /* âœ… PDF ì €ì¥ ì‹œ ë²„íŠ¼ ì•ˆ ë³´ì´ê²Œ ì„¤ì • */
        .pdf-hidden { display: block; }
        @media print {
            .pdf-hidden { display: none; }
        }
        
        .button-container { margin-top: 20px; }
    </style>
</head>
<body>

    <h1>ì¼ì‚°ë§¥ìŠ¤ì²´ëŒ€ì…ì‹œ ê¸‰ì—¬ëª…ì„¸ì„œ</h1>

    <!-- âœ… ì‹œê¸‰Â·ì¼ê¸‰Â·ì›”ê¸‰ ì…ë ¥ë€ì„ PDF ì €ì¥ ë²”ìœ„ ë°–ìœ¼ë¡œ ì´ë™ -->
    <div class="pdf-hidden">
        <div class="input-container">
            <label for="hourlyRate">ì‹œê¸‰ (â‚©):</label>
            <input type="number" id="hourlyRate" placeholder="ì˜ˆ: 25000">
        </div>

        <div class="input-container">
            <label for="dailyRate">ì¼ê¸‰ (â‚©):</label>
            <input type="number" id="dailyRate" placeholder="ì˜ˆ: 100000">
        </div>

        <div class="input-container">
            <label for="monthlySalary">ì›”ê¸‰ (â‚©):</label>
            <input type="number" id="monthlySalary" placeholder="ì˜ˆ: 3000000">
        </div>
    </div>

    <div class="payroll-container" id="payroll-section">
        <h2 id="payroll-title">#ê°•ì‚¬ì´ë¦„ #ì›” ê¸‰ì—¬ëª…ì„¸ì„œ</h2>

        <div class="input-container">
            <label for="teacher">ê°•ì‚¬ ì´ë¦„:</label>
            <select id="teacher" onchange="updateTitle();"></select>
        </div>

        <div class="input-container">
            <label for="month">ì›” ì„ íƒ:</label>
            <input type="month" id="month" onchange="updateTitle()">
        </div>

        <table class="payroll-table">
            <tr>
                <th>ì¶œê·¼ì¼ìˆ˜</th>
                <th>ì´ ê¸‰ì—¬</th>
                <th>ì„¸ê¸ˆ (3.3%)</th>
                <th>ì‹¤ìˆ˜ë ¹ì•¡</th>
            </tr>
            <tr>
                <td id="attendanceDays">-</td>
                <td id="totalSalary">â‚©0</td>
                <td id="taxAmount">â‚©0</td>
                <td id="netSalary">â‚©0</td>
            </tr>
        </table>

        
<!-- âœ… ì¶œê·¼ ë‚ ì§œë¥¼ í‘œì‹œí•˜ëŠ” ìƒˆë¡œìš´ í…Œì´ë¸” -->
<h3>ì¶œê·¼ ì¼ì</h3>
<table class="payroll-table">
    <thead>
        <tr>
            <th>ë‚ ì§œ</th>
            <th>ìš”ì¼</th>
        </tr>
    </thead>
    <tbody id="attendanceDatesTable">
        <tr><td colspan="2">ì¶œê·¼ ê¸°ë¡ ì—†ìŒ</td></tr>
    </tbody>
</table>

        <!-- âœ… ê°•ì¡°ëœ ì§ì¸ ìŠ¤íƒ€ì¼ -->
        <div class="signature">ë§¥ìŠ¤ì²´ëŒ€ì…ì‹œ ì¼ì‚°êµìœ¡ì›ì¥</div>
    </div>

    <!-- âœ… PDF ì €ì¥ ì‹œ ë²„íŠ¼ ì•ˆ ë³´ì´ë„ë¡ ì„¤ì • -->
    <div class="button-container pdf-hidden">
        <button onclick="calculateSalary()">ê¸‰ì—¬ ê³„ì‚°</button>
        <button onclick="downloadPDF()">PDF ì €ì¥</button>
        <button onclick="confirmSalary()">ê¸‰ì—¬ í™•ì •</button>
        <button onclick="openTossInWebView()">ê¸‰ì—¬ ì´ì²´</button>


    </div>
    

    <script>
        async function loadTeachers() {
            const response = await fetch('https://supermax.kr/teachers');
            const teachers = await response.json();
            const teacherSelect = document.getElementById('teacher');

            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.id;
                option.textContent = `${teacher.ì´ë¦„} (${teacher.ì§ê¸‰ || 'ê°•ì‚¬'})`;
                option.dataset.role = teacher.ì§ê¸‰ || 'ê°•ì‚¬'; 
                teacherSelect.appendChild(option);
            });
        }

        function updateTitle() {
            const teacherName = document.getElementById('teacher').selectedOptions[0].text.split(" ")[0];
            const monthValue = document.getElementById('month').value.split("-")[1] || "ì›”";
            document.getElementById('payroll-title').textContent = `#${teacherName} #${monthValue}ì›” ê¸‰ì—¬ëª…ì„¸ì„œ`;
        }

async function calculateSalary() {
    const teacherId = document.getElementById('teacher').value;
    const role = document.getElementById('teacher').selectedOptions[0].dataset.role;
    const monthValue = document.getElementById('month').value;
    const dailyRate = parseFloat(document.getElementById('dailyRate').value);
    const hourlyRate = parseFloat(document.getElementById('hourlyRate').value);
    const monthlySalary = parseFloat(document.getElementById('monthlySalary').value);

    if (!teacherId || !monthValue) {
        alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    const [year, month] = monthValue.split('-');
    const response = await fetch(`https://supermax.kr/attendancehistory_monthly?year=${year}&month=${month}`);
    const attendanceRecords = await response.json();

    // âœ… ì¶œê·¼ ë˜ëŠ” ì§€ê°í•œ ë‚ ì§œ ë¦¬ìŠ¤íŠ¸ ìƒì„± (UTC â†’ KST ë³€í™˜ ì¶”ê°€)
    const attendanceDays = attendanceRecords
        .filter(record => record.ê°•ì‚¬_id == teacherId && (record.ì¶œê·¼ === 1 || record.ì§€ê° === 1))
        .map(record => {
            const dateObj = new Date(record.ì¶œê·¼ì¼);
            const kstDate = new Date(dateObj.getTime() + (9 * 60 * 60 * 1000)); // âœ… í•œêµ­ ì‹œê°„(KST) ë³€í™˜
            const formattedDate = kstDate.toISOString().split('T')[0]; // YYYY-MM-DD
            const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][kstDate.getDay()]; // ìš”ì¼ ì¶”ì¶œ
            return { date: formattedDate, day: dayOfWeek };
        });

    let totalSalary = (role === "íŒ€ì¥") ? monthlySalary : attendanceDays.length * dailyRate;
    const taxAmount = (role === "íŒ€ì¥") ? totalSalary * 0.033 : 0;
    const netSalary = totalSalary - taxAmount;

    document.getElementById('attendanceDays').textContent = attendanceDays.length;
    document.getElementById('totalSalary').textContent = `â‚©${totalSalary.toLocaleString()}`;
    document.getElementById('taxAmount').textContent = `â‚©${taxAmount.toLocaleString()}`;
    document.getElementById('netSalary').textContent = `â‚©${netSalary.toLocaleString()}`;

    // âœ… HTML í…Œì´ë¸”ì— ì¶œê·¼ ë‚ ì§œ ì¶”ê°€
    const tableBody = document.getElementById('attendanceDatesTable');
    tableBody.innerHTML = "";

    if (attendanceDays.length > 0) {
        attendanceDays.forEach(day => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${day.date}</td><td>${day.day}</td>`;
            tableBody.appendChild(row);
        });
    } else {
        tableBody.innerHTML = `<tr><td colspan="2">ì¶œê·¼ ê¸°ë¡ ì—†ìŒ</td></tr>`;
    }
}
        async function confirmSalary() {
    const teacherId = document.getElementById('teacher').value;
    const teacherName = document.getElementById('teacher').selectedOptions[0].text.split(" ")[0];
    const monthValue = document.getElementById('month').value;
    const netSalary = parseFloat(document.getElementById('netSalary').textContent.replace(/â‚©|,/g, ''));

    if (!teacherId || !monthValue || isNaN(netSalary)) {
        alert("ê¸‰ì—¬ ê³„ì‚° í›„ í™•ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        return;
    }

    const [year, month] = monthValue.split('-');

    const salaryData = {
        year: parseInt(year),
        month: parseInt(month),
        teacherId: teacherId,
        teacherName: teacherName,
        salaryAmount: netSalary
    };

    const response = await fetch('https://supermax.kr/confirmSalary', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(salaryData)
    });

    if (response.ok) {
        alert("ê¸‰ì—¬ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
    } else {
        alert("ê¸‰ì—¬ í™•ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ!");
    }
}




async function downloadPDF() {
    const payrollSection = document.getElementById('payroll-section');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();

    // âœ… ì„ íƒëœ ê°•ì‚¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    const teacherName = document.getElementById('teacher').selectedOptions[0].text.split(" ")[0];

    // âœ… ì„ íƒëœ ë…„ì›” ê°€ì ¸ì˜¤ê¸° (YYYYMM í˜•ì‹)
    const monthValue = document.getElementById('month').value; // ex) "2025-03"
    if (!monthValue || !teacherName) {
        alert("ê°•ì‚¬ì™€ ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
        return;
    }
    const [year, month] = monthValue.split('-');
    const fileName = `${year}${month}_${teacherName}.pdf`; // ex) "202503_í™ê¸¸ë™.pdf"

    html2canvas(payrollSection).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        pdf.addImage(imgData, 'PNG', 10, 10, 180, 0);
        pdf.save(fileName);
    });
}
function openTossInWebView() {
    const teacherId = document.getElementById('teacher').value;
    const teacherName = document.getElementById('teacher').selectedOptions[0].text.split(" ")[0];
    const salaryAmount = parseFloat(document.getElementById('netSalary').textContent.replace(/â‚©|,/g, ''));

    if (!teacherId || !teacherName || isNaN(salaryAmount)) {
        alert("ê¸‰ì—¬ ê³„ì‚° í›„ ì´ì²´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        return;
    }

    // âœ… ê°•ì‚¬ ê³„ì¢Œë²ˆí˜¸ & ì€í–‰ëª… ì¡°íšŒ
    fetch(`https://supermax.kr/getTeacherAccount?teacherId=${teacherId}`)
        .then(response => response.json())
        .then(result => {
            if (!result.ê³„ì¢Œë²ˆí˜¸ || !result.ì€í–‰ëª…) {
                alert("ê³„ì¢Œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const bankName = encodeURIComponent(result.ì€í–‰ëª…);
            const bankAccount = encodeURIComponent(result.ê³„ì¢Œë²ˆí˜¸);
            const message = encodeURIComponent(teacherName + ' ê¸‰ì—¬');

            // âœ… Toss ì•± ì‹¤í–‰ URL ìƒì„±
            const tossUrl = `toss://send?recipientBank=${bankName}&recipientAccount=${bankAccount}&amount=${salaryAmount}&message=${message}`;

            // âœ… WebView ìƒì„± í›„ Toss ì•± ì‹¤í–‰
            const webview = document.createElement('iframe');
            webview.src = tossUrl;
            webview.style.display = "none"; // í™”ë©´ì— í‘œì‹œë˜ì§€ ì•Šë„ë¡ ì„¤ì •
            document.body.appendChild(webview);

            webview.addEventListener('loadstart', () => {
                console.log("í† ìŠ¤ ì•±ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.");
            });

            webview.addEventListener('error', () => {
                alert("Toss ì•±ì´ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                document.body.removeChild(webview);
            });

            // âœ… ì¼ì • ì‹œê°„ í›„ WebView ì œê±° (ì•ˆì „ ì²˜ë¦¬)
            setTimeout(() => {
                if (document.body.contains(webview)) {
                    document.body.removeChild(webview);
                }
            }, 5000);
        })
        .catch(error => {
            console.error("ğŸš¨ ê³„ì¢Œ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:", error);
            alert("ê³„ì¢Œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
}








        loadTeachers();
    </script>

</body>
</html>
