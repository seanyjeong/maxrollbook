<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸‰ì—¬ëª…ì„¸ì„œ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { text-align: center; }
        .payroll-container { max-width: 600px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 10px; background: white; }
        .input-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .input-container label { flex: 1; text-align: left; }
        .input-container input, .input-container select { flex: 2; padding: 5px; }
        .payroll-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .payroll-table th, .payroll-table td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        .signature { margin-top: 20px; font-size: 24px; font-weight: bold; }

            /* PDF ì¶œë ¥ìš© ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    @media print {
        .payroll-container {
            width: 100% !important;
            max-width: none !important;
            margin: 0 !important;
            padding: 10px !important;
            transform: none !important;
        }
        
        body {
            margin: 0;
            padding: 0;
        }
        
        .payroll-table {
            page-break-inside: avoid;
            margin-bottom: 20px;
        }
        
        /* í…Œì´ë¸” ì…€ í¬ê¸° ì¡°ì • */
        .payroll-table th,
        .payroll-table td {
            padding: 5px !important;
            font-size: 12px !important;
            white-space: nowrap;
        }
    }

    /* ì»¨í…Œì´ë„ˆ ìµœì†Œ ë†’ì´ ì„¤ì • */
    #payroll-section {
        min-height: 600px;
    }

        /* í…Œì´ë¸” ìë™ í¬ê¸° ì¡°ì ˆ */
        .payroll-table {
            width: 100%;
            table-layout: fixed;
            font-size: 0.9em;
        }

        /* ì…€ ë‚´ìš© ìë™ í¬ê¸° ì¡°ì ˆ */
        .payroll-table td, .payroll-table th {
            padding: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ê¸ˆì•¡ ì…€ íŠ¹ë³„ ì²˜ë¦¬ */
        .payroll-table td.amount {
            font-size: 0.85em;
            font-family: monospace;  /* ìˆ«ì ê°„ê²© ì¼ì •í•˜ê²Œ */
        }

        /* í—¤ë” í¬ê¸° ì¡°ì ˆ */
        h1 { font-size: 1.5em; }
        h2 { font-size: 1.3em; }
        h3 { font-size: 1.1em; }

        /* ì„œëª… í¬ê¸° ì¡°ì ˆ */
        .signature {
            font-size: 1.2em;
            margin-top: 15px;
        }
    }

    /* ë™ì  í°íŠ¸ í¬ê¸° ì¡°ì ˆì„ ìœ„í•œ í´ë˜ìŠ¤ */
    .auto-size {
        font-size: clamp(0.7em, 2vw, 1em);
    }
    </style>
</head>
<body>
    <h1>ì¼ì‚° ë§¥ìŠ¤ì²´ëŒ€ì…ì‹œ ê¸‰ì—¬ëª…ì„¸ì„œ</h1>

    <div class="input-container">
        <label>ê¸‰ì—¬ ë°©ì‹:</label>
        <select id="salaryType">
            <option value="hourly">ì‹œê¸‰</option>
            <option value="daily">ì¼ê¸‰</option>
            <option value="monthly">ì›”ê¸‰</option>
        </select>
    </div>

    <div class="input-container">
        <label for="hourlyRate">ì‹œê¸‰ (â‚©):</label>
        <input type="number" id="hourlyRate" placeholder="ì˜ˆ: 25000">
    </div>

    <div class="input-container">
        <label for="dailyRate">ì¼ê¸‰ (â‚©):</label>
        <input type="number" id="dailyRate" placeholder="ì˜ˆ: 100000">
    </div>

    <div class="input-container">
        <label for="monthlySalary">ì›”ê¸‰ (â‚©):</label>
        <input type="number" id="monthlySalary" placeholder="ì˜ˆ: 3000000">
    </div>

    <div class="input-container">
        <label for="incentive1">ì¸ì„¼í‹°ë¸Œ1 (ì‹ ê·œí•™ìƒ ìˆ˜):</label>
        <input type="number" id="incentive1" placeholder="ì‹ ê·œí•™ìƒ ìˆ˜ ì…ë ¥">
    </div>

    <div class="input-container">
        <label for="incentive2">ì¸ì„¼í‹°ë¸Œ2 (ê¸°íƒ€ ê¸ˆì•¡):</label>
        <input type="number" id="incentive2" placeholder="ê¸°íƒ€ ì¸ì„¼í‹°ë¸Œ ê¸ˆì•¡">
    </div>

    <div class="input-container">
        <label>ì„¸ê¸ˆ ì ìš© (3.3%)</label>
        <input type="checkbox" id="applyTax">
    </div>

    <div class="payroll-container" id="payroll-section">
        <h2 id="payroll-title">#ê°•ì‚¬ì´ë¦„ #ì›” ê¸‰ì—¬ëª…ì„¸ì„œ</h2>

        <div class="input-container">
            <label for="teacher">ê°•ì‚¬ ì´ë¦„:</label>
            <select id="teacher" onchange="updateTitle();"></select>
        </div>

        <div class="input-container">
            <label for="month">ì›” ì„ íƒ:</label>
            <input type="month" id="month" onchange="updateTitle()">
        </div>

        <h3>ì¶œê·¼ ì¼ì</h3>
        <p id="totalAttendanceDisplay">ì´ ì¶œê·¼ì¼ìˆ˜: 0ì¼</p>

<table class="payroll-table">
    <tr>
        <th>ì¶œê·¼ì¼ìˆ˜</th>
        <th>ì´ ê·¼ë¬´ì‹œê°„</th>
        <th>ì´ ê¸‰ì—¬</th>
        <th>ì„¸ê¸ˆ (3.3%)</th>
        <th>ì¸ì„¼í‹°ë¸Œ1</th>
        <th>ì¸ì„¼í‹°ë¸Œ2</th>
        <th>ì‹¤ìˆ˜ë ¹ì•¡</th>
    </tr>
    <tr>
        <td id="attendanceDays" class="auto-size">0</td>
        <td id="totalHours" class="auto-size">0ì‹œê°„</td>
        <td id="totalSalary" class="amount auto-size">â‚©0</td>
        <td id="taxAmount" class="amount auto-size">â‚©0</td>
        <td id="incentive1Amount" class="amount auto-size">â‚©0</td>
        <td id="incentive2Amount" class="amount auto-size">â‚©0</td>
        <td id="netSalary" class="amount auto-size">â‚©0</td>
    </tr>
</table>

        <h3>ì¶œê·¼ ìƒì„¸ ê¸°ë¡</h3>
        <table class="payroll-table">
            <thead>
                <tr>
                    <th>ë‚ ì§œ</th>
                    <th>ìš”ì¼</th>
                    <th>ê·¼ë¬´ì‹œê°„</th>
                </tr>
            </thead>
            <tbody id="attendanceTable">
                <tr><td colspan="3">ì¶œê·¼ ê¸°ë¡ ì—†ìŒ</td></tr>
            </tbody>
        </table>

        <div class="signature">ë§¥ìŠ¤ì²´ëŒ€ì…ì‹œ ì¼ì‚°êµìœ¡ì›ì¥</div>
    </div>

    <button onclick="calculateSalary()" style="margin-top: 10px;">ê¸‰ì—¬ ê³„ì‚°</button>
    <button onclick="downloadPDF()" style="margin-top: 10px;">PDF ì €ì¥</button>
    <button onclick="confirmSalary()" style="margin-top: 10px;">ê¸‰ì—¬ í™•ì •</button>

    <script>
        async function loadTeachers() {
            console.log("ğŸ“¢ ê°•ì‚¬ ëª©ë¡ ë¡œë“œ ì‹œì‘");
            try {
                const response = await fetch('https://supermax.kr/teachers');
                const teachers = await response.json();
                console.log("âœ… ê°•ì‚¬ ëª©ë¡ ì‘ë‹µ:", teachers);
                const teacherSelect = document.getElementById('teacher');
                teacherSelect.innerHTML = teachers.map(teacher => 
                    `<option value="${teacher.id}">${teacher.ì´ë¦„} (${teacher.ì§ê¸‰ || 'ê°•ì‚¬'})</option>`
                ).join('');
                console.log("ğŸ“¢ ê°•ì‚¬ ëª©ë¡ ë¡œë“œ ì™„ë£Œ");
                updateTitle();
            } catch (error) {
                console.error("âŒ ê°•ì‚¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
            }
        }

        async function updateTitle() {
            const teacherSelect = document.getElementById('teacher');
            if (!teacherSelect || teacherSelect.selectedIndex === -1) return;
            const teacherName = teacherSelect.selectedOptions[0].text.split(" ")[0];
            const monthValue = document.getElementById('month').value.split("-")[1] || "ì›”";
            document.getElementById('payroll-title').textContent = `#${teacherName} #${monthValue}ì›” ê¸‰ì—¬ëª…ì„¸ì„œ`;
            await loadSalaryData();
        }

        async function loadSalaryData() {
            const teacherId = document.getElementById('teacher').value;
            const monthValue = document.getElementById('month').value;
            if (!teacherId || !monthValue) return;

            const [year, month] = monthValue.split('-');
            const response = await fetch(`https://supermax.kr/getSalary?year=${year}&month=${month}&teacherId=${teacherId}`);

            if (!response.ok) {
                document.getElementById('applyTax').checked = false;
                document.getElementById('incentive1').value = '';
                document.getElementById('incentive2').value = '';
                return;
            }

            const salaryData = await response.json();
            console.log("âœ… ê¸‰ì—¬ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°:", salaryData);

            document.getElementById('salaryType').value = salaryData.ê¸‰ì—¬ë°©ì‹;
            document.getElementById('hourlyRate').value = salaryData.ì‹œê¸‰ || '';
            document.getElementById('dailyRate').value = salaryData.ì¼ê¸‰ || '';
            document.getElementById('monthlySalary').value = salaryData.ì›”ê¸‰ || '';
            document.getElementById('applyTax').checked = salaryData.applyTax || false;
            document.getElementById('incentive1').value = salaryData.ì¸ì„¼í‹°ë¸Œ1 || '';
            document.getElementById('incentive2').value = salaryData.ì¸ì„¼í‹°ë¸Œ2 || '';

            calculateSalary();
        }

        async function calculateSalary() {
            const teacherId = document.getElementById('teacher').value;
            const monthValue = document.getElementById('month').value;
            const salaryType = document.getElementById('salaryType').value;
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
            const dailyRate = parseFloat(document.getElementById('dailyRate').value) || 0;
            const monthlySalary = parseFloat(document.getElementById('monthlySalary').value) || 0;
            const applyTax = document.getElementById('applyTax').checked;
            const incentive1Count = parseInt(document.getElementById('incentive1').value) || 0;
            const incentive2Amount = parseFloat(document.getElementById('incentive2').value) || 0;

            if (!teacherId || !monthValue) {
                alert('ê°•ì‚¬ ë° ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const [year, month] = monthValue.split('-');
            const response = await fetch(`https://supermax.kr/attendancehistory_monthly?year=${year}&month=${month}`);
            const attendanceRecords = await response.json();

            let totalHours = 0;
            let totalDays = 0;

            const tableBody = document.getElementById('attendanceTable');
            tableBody.innerHTML = "";

            attendanceRecords.forEach(record => {
                if (record.ê°•ì‚¬_id == teacherId && (record.ì¶œê·¼ === 1 || record.ì§€ê° === 1)) {
                    totalDays++;
                    const dateObj = new Date(record.ì¶œê·¼ì¼);
                    const kstDate = new Date(dateObj.getTime() + (9 * 60 * 60 * 1000));
                    const formattedDate = kstDate.toISOString().split('T')[0];
                    const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][kstDate.getDay()];
                    const workHours = record.ê·¼ë¬´ì‹œê°„ !== undefined ? record.ê·¼ë¬´ì‹œê°„ : 0;
                    totalHours += workHours;

                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${formattedDate}</td><td>${dayOfWeek}</td><td>${workHours}ì‹œê°„</td>`;
                    tableBody.appendChild(row);
                }
            });

            document.getElementById('totalAttendanceDisplay').textContent = `ì´ ì¶œê·¼ì¼ìˆ˜: ${totalDays}ì¼`;

            const incentive1Amount = incentive1Count * 100000;
            let totalSalary = salaryType === "hourly" ? totalHours * hourlyRate :
                          salaryType === "daily" ? totalDays * dailyRate :
                          monthlySalary;

            let taxAmount = applyTax ? totalSalary * 0.033 : 0;
            let netSalary = totalSalary - taxAmount + incentive1Amount + incentive2Amount;
            netSalary = Math.floor(netSalary / 10) * 10;

            document.getElementById('attendanceDays').textContent = totalDays;
            document.getElementById('totalHours').textContent = `${totalHours}ì‹œê°„`;
            document.getElementById('totalSalary').textContent = `â‚©${totalSalary.toLocaleString()}`;
            document.getElementById('taxAmount').textContent = `â‚©${taxAmount.toLocaleString()}`;
            document.getElementById('incentive1Amount').textContent = `â‚©${incentive1Amount.toLocaleString()}`;
            document.getElementById('incentive2Amount').textContent = `â‚©${incentive2Amount.toLocaleString()}`;
            document.getElementById('netSalary').textContent = `â‚©${netSalary.toLocaleString()}`;
        }

        async function confirmSalary() {
            const teacherSelect = document.getElementById('teacher');
            const teacherId = teacherSelect.value;
            const teacherName = teacherSelect.selectedOptions[0].text.split(" ")[0];
            const monthValue = document.getElementById('month').value;

            if (!teacherId || !monthValue) {
                alert("ê°•ì‚¬ ë° ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            const [year, month] = monthValue.split('-');
            const salaryType = document.getElementById('salaryType').value;
            const hourlyWage = parseFloat(document.getElementById('hourlyRate').value) || 0;
            const dailyWage = parseFloat(document.getElementById('dailyRate').value) || 0;
            const monthlyWage = parseFloat(document.getElementById('monthlySalary').value) || 0;
            const incentive1Count = parseInt(document.getElementById('incentive1').value) || 0;
            const incentive2Amount = parseFloat(document.getElementById('incentive2').value) || 0;
            
            let totalSalary = Math.floor(parseFloat(document.getElementById('totalSalary').textContent.replace(/â‚©|,/g, '')) / 10) * 10;
            let taxAmount = Math.floor(parseFloat(document.getElementById('taxAmount').textContent.replace(/â‚©|,/g, '')) / 10) * 10;
            let salaryAmount = Math.floor(parseFloat(document.getElementById('netSalary').textContent.replace(/â‚©|,/g, '')) / 10) * 10;
            const applyTax = document.getElementById('applyTax').checked;

            const salaryData = { 
                year, month, teacherId, teacherName, totalSalary, taxAmount, salaryAmount,
                salaryType, totalHours, totalDays, hourlyWage, dailyWage, monthlyWage, applyTax,
                incentive1: incentive1Count,
                incentive2: incentive2Amount
            };

            console.log("ğŸ“¤ ì„œë²„ë¡œ ë³´ë‚´ëŠ” ë°ì´í„°:", salaryData);

            const response = await fetch('https://supermax.kr/confirmSalary', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(salaryData)
            });

            if (response.ok) {
                alert("âœ… ê¸‰ì—¬ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
            } else {
                alert("âŒ ê¸‰ì—¬ í™•ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ!");
                const errorText = await response.text();
                console.error("âŒ ì„œë²„ ì˜¤ë¥˜ ì‘ë‹µ:", errorText);
            }
        }

async function downloadPDF() {
    const payrollSection = document.getElementById('payroll-section');
    const { jsPDF } = window.jspdf;

    try {
        // 1. ìº”ë²„ìŠ¤ ìƒì„± ì „ ì¤€ë¹„
        const originalStyles = {
            width: payrollSection.style.width,
            height: payrollSection.style.height,
            transform: payrollSection.style.transform,
            position: payrollSection.style.position
        };

        // 2. PDF ìƒì„±ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ ì ìš©
        payrollSection.style.width = '1000px';
        payrollSection.style.height = 'auto';
        payrollSection.style.transform = 'none';
        payrollSection.style.position = 'relative';

        // 3. ìº”ë²„ìŠ¤ ìƒì„±
        const canvas = await html2canvas(payrollSection, {
            scale: 2,
            useCORS: true,
            logging: false,
            letterRendering: true,
            allowTaint: true,
            backgroundColor: '#ffffff'
        });

        // 4. PDF ì„¤ì • (A4 ê°€ë¡œ)
        const pdf = new jsPDF('landscape', 'mm', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        
        // 5. ì´ë¯¸ì§€ ë°ì´í„° ì¤€ë¹„
        const imgData = canvas.toDataURL('image/png', 1.0);
        
        // 6. ì´ë¯¸ì§€ í¬ê¸° ê³„ì‚°
        const imgWidth = pageWidth - 20;  // ì¢Œìš° 10mm ì—¬ë°±
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        // 7. ì—¬ëŸ¬ í˜ì´ì§€ë¡œ ë¶„í• 
        let heightLeft = imgHeight;
        let position = 0;
        
        // ì²« í˜ì´ì§€
        pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        // ì¶”ê°€ í˜ì´ì§€
        while (heightLeft > 0) {
            position = -pageHeight * (imgHeight / heightLeft);
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }

        // 8. íŒŒì¼ëª… ì„¤ì • ë° ì €ì¥
        const teacherName = document.getElementById('teacher').selectedOptions[0].text.split(" ")[0];
        const monthValue = document.getElementById('month').value;
        
        if (!monthValue || !teacherName) {
            alert("ê°•ì‚¬ì™€ ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
            return;
        }

        const [year, month] = monthValue.split('-');
        const fileName = `${year}${month}_${teacherName}_ê¸‰ì—¬ëª…ì„¸ì„œ.pdf`;
        pdf.save(fileName);

    } catch (error) {
        console.error('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
        alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
        // 9. ì›ë˜ ìŠ¤íƒ€ì¼ë¡œ ë³µêµ¬
        Object.assign(payrollSection.style, originalStyles);
    }
}
        document.addEventListener("DOMContentLoaded", loadTeachers);
    </script>
    <footer style="margin-top: 20px; text-align: center; font-size: 12px; color: #666;">
        &copy; 2025 ì¼ì‚°ë§¥ìŠ¤ ê°•ì‚¬ ì¶œê·¼ë¶€ ì‹œìŠ¤í…œ BY ì •ì›ì¥
    </footer>
</body>
</html>
