<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸‰ì—¬ëª…ì„¸ì„œ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { text-align: center; }
        .payroll-container { max-width: 600px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 10px; background: white; }
        .input-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .input-container label { flex: 1; text-align: left; }
        .input-container input, .input-container select { flex: 2; padding: 5px; }
        .payroll-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .payroll-table th, .payroll-table td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        .signature { margin-top: 20px; font-size: 24px; font-weight: bold; }
    </style>
</head>
<body>

    <h1>ì¼ì‚° ë§¥ìŠ¤ì²´ëŒ€ì…ì‹œ ê¸‰ì—¬ëª…ì„¸ì„œ</h1>

    <div class="input-container">
        <label>ê¸‰ì—¬ ë°©ì‹:</label>
        <select id="salaryType">
            <option value="hourly">ì‹œê¸‰</option>
            <option value="daily">ì¼ê¸‰</option>
            <option value="monthly">ì›”ê¸‰</option>
        </select>
    </div>

    <div class="input-container">
        <label for="hourlyRate">ì‹œê¸‰ (â‚©):</label>
        <input type="number" id="hourlyRate" placeholder="ì˜ˆ: 25000">
    </div>

    <div class="input-container">
        <label for="dailyRate">ì¼ê¸‰ (â‚©):</label>
        <input type="number" id="dailyRate" placeholder="ì˜ˆ: 100000">
    </div>

    <div class="input-container">
        <label for="monthlySalary">ì›”ê¸‰ (â‚©):</label>
        <input type="number" id="monthlySalary" placeholder="ì˜ˆ: 3000000">
    </div>

    <div class="input-container">
        <label>ì„¸ê¸ˆ ì ìš© (3.3%)</label>
        <input type="checkbox" id="applyTax">
    </div>

    <div class="payroll-container" id="payroll-section">
        <h2 id="payroll-title">#ê°•ì‚¬ì´ë¦„ #ì›” ê¸‰ì—¬ëª…ì„¸ì„œ</h2>

        <div class="input-container">
            <label for="teacher">ê°•ì‚¬ ì´ë¦„:</label>
            <select id="teacher" onchange="updateTitle();"></select>
        </div>

        <div class="input-container">
            <label for="month">ì›” ì„ íƒ:</label>
            <input type="month" id="month" onchange="updateTitle()">
        </div>

        <h3>ì¶œê·¼ ì¼ì</h3>
<p id="totalAttendanceDisplay">ì´ ì¶œê·¼ì¼ìˆ˜: 0ì¼</p>  <!-- âœ… ì´ ë¶€ë¶„ì´ ì—†ìœ¼ë©´ ì¶”ê°€í•´ì•¼ í•¨ -->


        <table class="payroll-table">
            <tr>
                <th>ì¶œê·¼ì¼ìˆ˜</th>
                <th>ì´ ê·¼ë¬´ì‹œê°„</th>
                <th>ì´ ê¸‰ì—¬</th>
                <th>ì„¸ê¸ˆ (3.3%)</th>
                <th>ì‹¤ìˆ˜ë ¹ì•¡</th>
            </tr>
            <tr>
                <td id="attendanceDays">0</td>
                <td id="totalHours">0ì‹œê°„</td>
                <td id="totalSalary">â‚©0</td>
                <td id="taxAmount">â‚©0</td>
                <td id="netSalary">â‚©0</td>
            </tr>
        </table>

        <h3>ì¶œê·¼ ìƒì„¸ ê¸°ë¡</h3>
        <table class="payroll-table">
            <thead>
                <tr>
                    <th>ë‚ ì§œ</th>
                    <th>ìš”ì¼</th>
                    <th>ê·¼ë¬´ì‹œê°„</th>
                </tr>
            </thead>
            <tbody id="attendanceTable">
                <tr><td colspan="3">ì¶œê·¼ ê¸°ë¡ ì—†ìŒ</td></tr>
            </tbody>
        </table>

        <div class="signature">ë§¥ìŠ¤ì²´ëŒ€ì…ì‹œ ì¼ì‚°êµìœ¡ì›ì¥</div>
    </div>

<button onclick="calculateSalary()" style="margin-top: 10px;">ê¸‰ì—¬ ê³„ì‚°</button>
<button onclick="downloadPDF()" style="margin-top: 10px;">PDF ì €ì¥</button>
<button onclick="confirmSalary()" style="margin-top: 10px;">ê¸‰ì—¬ í™•ì •</button>

    
    <script>
async function loadTeachers() {
    console.log("ğŸ“¢ ê°•ì‚¬ ëª©ë¡ ë¡œë“œ ì‹œì‘");
    
    try {
        const response = await fetch('https://supermax.kr/teachers');
        const teachers = await response.json();

        console.log("âœ… ê°•ì‚¬ ëª©ë¡ ì‘ë‹µ:", teachers);  // ğŸ“¢ API ì‘ë‹µ í™•ì¸

        const teacherSelect = document.getElementById('teacher');

        // âœ… ê°•ì‚¬ ëª©ë¡ì´ ìˆìœ¼ë©´ `<select>` ì•ˆì— ì˜µì…˜ ì¶”ê°€
        teacherSelect.innerHTML = teachers.map(teacher => 
            `<option value="${teacher.id}">${teacher.ì´ë¦„} (${teacher.ì§ê¸‰ || 'ê°•ì‚¬'})</option>`
        ).join('');

        console.log("ğŸ“¢ ê°•ì‚¬ ëª©ë¡ ë¡œë“œ ì™„ë£Œ");
        updateTitle();  // âœ… ê°•ì‚¬ ì„ íƒ í›„ ì œëª© ì—…ë°ì´íŠ¸

    } catch (error) {
        console.error("âŒ ê°•ì‚¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
    }
}

// âœ… DOMì´ ì™„ì „íˆ ë¡œë“œëœ í›„ ì‹¤í–‰
document.addEventListener("DOMContentLoaded", loadTeachers);


 async function updateTitle() {
    const teacherSelect = document.getElementById('teacher');

    if (!teacherSelect || teacherSelect.selectedIndex === -1) return;

    const teacherName = teacherSelect.selectedOptions[0].text.split(" ")[0];
    const monthValue = document.getElementById('month').value.split("-")[1] || "ì›”";
    document.getElementById('payroll-title').textContent = `#${teacherName} #${monthValue}ì›” ê¸‰ì—¬ëª…ì„¸ì„œ`;

    // âœ… ê°•ì‚¬ì™€ ì›” ì„ íƒ ì‹œ ê¸‰ì—¬ ë°ì´í„° ìë™ ë¡œë“œ
    await loadSalaryData();
}

async function loadSalaryData() {
    const teacherId = document.getElementById('teacher').value;
    const monthValue = document.getElementById('month').value;
    if (!teacherId || !monthValue) return;

    const [year, month] = monthValue.split('-');
    const response = await fetch(`https://supermax.kr/getSalary?year=${year}&month=${month}&teacherId=${teacherId}`);

    if (!response.ok) {
        document.getElementById('applyTax').checked = false; // ê¸°ë³¸ê°’ false
        return;
    }

    const salaryData = await response.json();
    console.log("âœ… ê¸‰ì—¬ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°:", salaryData);

    document.getElementById('salaryType').value = salaryData.ê¸‰ì—¬ë°©ì‹;
    document.getElementById('hourlyRate').value = salaryData.ì‹œê¸‰ || '';
    document.getElementById('dailyRate').value = salaryData.ì¼ê¸‰ || '';
    document.getElementById('monthlySalary').value = salaryData.ì›”ê¸‰ || '';
    
    // âœ… ì„¸ê¸ˆ ì²´í¬ë°•ìŠ¤ ë°˜ì˜
    document.getElementById('applyTax').checked = salaryData.applyTax || false;



    calculateSalary();
}



let totalDays = 0;  // âœ… ì¶œê·¼ì¼ìˆ˜ ì „ì—­ ë³€ìˆ˜
let totalHours = 0; // âœ… ì´ ê·¼ë¬´ì‹œê°„ ì „ì—­ ë³€ìˆ˜

async function calculateSalary() {
    const teacherId = document.getElementById('teacher').value;
    const monthValue = document.getElementById('month').value;
    const salaryType = document.getElementById('salaryType').value;
    const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
    const dailyRate = parseFloat(document.getElementById('dailyRate').value) || 0;
    const monthlySalary = parseFloat(document.getElementById('monthlySalary').value) || 0;
    const applyTax = document.getElementById('applyTax').checked;

    if (!teacherId || !monthValue) {
        alert('ê°•ì‚¬ ë° ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    const [year, month] = monthValue.split('-');
    const response = await fetch(`https://supermax.kr/attendancehistory_monthly?year=${year}&month=${month}`);
    const attendanceRecords = await response.json();

    totalHours = 0;  // âœ… ì´ ê·¼ë¬´ì‹œê°„ ì´ˆê¸°í™”
    totalDays = 0;   // âœ… ì´ ì¶œê·¼ì¼ìˆ˜ ì´ˆê¸°í™”

    const tableBody = document.getElementById('attendanceTable');
    tableBody.innerHTML = "";

    attendanceRecords.forEach(record => {
        if (record.ê°•ì‚¬_id == teacherId && (record.ì¶œê·¼ === 1 || record.ì§€ê° === 1)) {
            totalDays++; 

            const dateObj = new Date(record.ì¶œê·¼ì¼);
            const kstDate = new Date(dateObj.getTime() + (9 * 60 * 60 * 1000)); // í•œêµ­ ì‹œê°„ ë³€í™˜
            const formattedDate = kstDate.toISOString().split('T')[0];
            const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][kstDate.getDay()];

            const workHours = record.ê·¼ë¬´ì‹œê°„ !== undefined ? record.ê·¼ë¬´ì‹œê°„ : 0;
            totalHours += workHours; // âœ… ì´ ê·¼ë¬´ì‹œê°„ ëˆ„ì 

            const row = document.createElement('tr');
            row.innerHTML = `<td>${formattedDate}</td><td>${dayOfWeek}</td><td>${workHours}ì‹œê°„</td>`;
            tableBody.appendChild(row);
        }
    });

    document.getElementById('totalAttendanceDisplay').textContent = `ì´ ì¶œê·¼ì¼ìˆ˜: ${totalDays}ì¼`;

    let totalSalary = salaryType === "hourly" ? totalHours * hourlyRate :
                      salaryType === "daily" ? totalDays * dailyRate :
                      monthlySalary;

    let taxAmount = applyTax ? totalSalary * 0.033 : 0;
    let netSalary = totalSalary - taxAmount;

    netSalary = Math.floor(netSalary / 10) * 10; // âœ… 10ì› ë‹¨ìœ„ ì ˆì‚­

    document.getElementById('attendanceDays').textContent = totalDays;
    document.getElementById('totalHours').textContent = `${totalHours}ì‹œê°„`;
    document.getElementById('totalSalary').textContent = `â‚©${totalSalary.toLocaleString()}`;
    document.getElementById('taxAmount').textContent = `â‚©${taxAmount.toLocaleString()}`;
    document.getElementById('netSalary').textContent = `â‚©${netSalary.toLocaleString()}`;
}





            // ì´ ì¶œê·¼ì¼ìˆ˜ ì—…ë°ì´íŠ¸
            document.getElementById('totalAttendanceDisplay').textContent = "ì´ ì¶œê·¼ì¼ìˆ˜: " + attendanceDays.length + "ì¼";

            // HTML í…Œì´ë¸”ì— ì¶œê·¼ ë‚ ì§œ ì¶”ê°€
            const tableBody = document.getElementById('attendanceDatesTable');
            tableBody.innerHTML = "";

            if (attendanceDays.length > 0) {
                attendanceDays.forEach(day => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${day.date}</td><td>${day.day}</td>`;
                    tableBody.appendChild(row);
                });
            } else {
                tableBody.innerHTML = `<tr><td colspan="2">ì¶œê·¼ ê¸°ë¡ ì—†ìŒ</td></tr>`;
            }
        

async function confirmSalary() {
    const teacherSelect = document.getElementById('teacher');
    const teacherId = teacherSelect.value;
    const teacherName = teacherSelect.selectedOptions[0].text.split(" ")[0];
    const monthValue = document.getElementById('month').value;

    if (!teacherId || !monthValue) {
        alert("ê°•ì‚¬ ë° ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
    }

    const [year, month] = monthValue.split('-');
    const salaryType = document.getElementById('salaryType').value;
    const hourlyWage = parseFloat(document.getElementById('hourlyRate').value) || 0;
    const dailyWage = parseFloat(document.getElementById('dailyRate').value) || 0;
    const monthlyWage = parseFloat(document.getElementById('monthlySalary').value) || 0;
    
    let totalSalary = Math.floor(parseFloat(document.getElementById('totalSalary').textContent.replace(/â‚©|,/g, '')) / 10) * 10;
    let taxAmount = Math.floor(parseFloat(document.getElementById('taxAmount').textContent.replace(/â‚©|,/g, '')) / 10) * 10;
    let salaryAmount = Math.floor(parseFloat(document.getElementById('netSalary').textContent.replace(/â‚©|,/g, '')) / 10) * 10;
    const applyTax = document.getElementById('applyTax').checked;

    const salaryData = { 
        year, month, teacherId, teacherName, totalSalary, taxAmount, salaryAmount,
        salaryType, totalHours, totalDays, hourlyWage, dailyWage, monthlyWage, applyTax 
    };

    console.log("ğŸ“¤ ì„œë²„ë¡œ ë³´ë‚´ëŠ” ë°ì´í„°:", salaryData);

    const response = await fetch('https://supermax.kr/confirmSalary', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(salaryData)
    });

    if (response.ok) {
        alert("âœ… ê¸‰ì—¬ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
    } else {
        alert("âŒ ê¸‰ì—¬ í™•ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ!");
        const errorText = await response.text();
        console.error("âŒ ì„œë²„ ì˜¤ë¥˜ ì‘ë‹µ:", errorText);
    }
}






        async function downloadPDF() {
            const payrollSection = document.getElementById('payroll-section');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();

            // ì„ íƒëœ ê°•ì‚¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
            const teacherName = document.getElementById('teacher').selectedOptions[0].text.split(" ")[0];

            // ì„ íƒëœ ë…„ì›” ê°€ì ¸ì˜¤ê¸° (YYYYMM í˜•ì‹)
            const monthValue = document.getElementById('month').value;
            if (!monthValue || !teacherName) {
                alert("ê°•ì‚¬ì™€ ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
                return;
            }
            const [year, month] = monthValue.split('-');
            const fileName = `${year}${month}_${teacherName}.pdf`;

            html2canvas(payrollSection).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 10, 10, 180, 0);
                pdf.save(fileName);
            });
        }

        loadTeachers();
    </script>
    <footer style="margin-top: 20px; text-align: center; font-size: 12px; color: #666;">
        &copy; 2025 ì¼ì‚°ë§¥ìŠ¤ ê°•ì‚¬ ì¶œê·¼ë¶€ ì‹œìŠ¤í…œ BY ì •ì›ì¥
    </footer>
</body>
</html>
