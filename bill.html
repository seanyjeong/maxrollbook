<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>급여명세서</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { text-align: center; }
        .payroll-container { max-width: 600px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 10px; background: white; }
        .input-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .input-container label { flex: 1; text-align: left; }
        .input-container input { flex: 2; padding: 5px; }
        .payroll-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .payroll-table th, .payroll-table td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        .signature { margin-top: 20px; font-size: 20px; font-weight: bold; } /* 직인 스타일 */
        .hidden-pdf { display: block; } /* 화면에서는 보이지만 PDF 저장 시 숨김 */
        .hidden-pdf-pdf { display: none; } /* PDF에서만 보이도록 */
        @media print {
            .hidden-pdf { display: none; } /* PDF 저장 시 숨김 */
            .hidden-pdf-pdf { display: block; } /* PDF에서만 보이도록 */
        }
        .button-container { margin-top: 20px; }
    </style>
</head>
<body>

    <h1>일산맥스체대입시 급여명세서</h1>

    <div class="payroll-container" id="payroll-section">
        <h2 id="payroll-title">#강사이름 #월 급여명세서</h2>

        <div class="input-container">
            <label for="teacher">강사 이름:</label>
            <select id="teacher" onchange="updateTitle(); toggleSalaryInputs();"></select>
        </div>

        <div class="input-container">
            <label for="month">월 선택:</label>
            <input type="month" id="month" onchange="updateTitle()">
        </div>

        <!-- ✅ 시급·일급·월급 입력 가능 -->
        <div class="input-container salary-input hidden-pdf" id="hourlyRateContainer">
            <label for="hourlyRate">시급 (₩):</label>
            <input type="number" id="hourlyRate" placeholder="예: 25000">
        </div>

        <div class="input-container salary-input hidden-pdf" id="dailyRateContainer">
            <label for="dailyRate">일급 (₩):</label>
            <input type="number" id="dailyRate" placeholder="예: 100000">
        </div>

        <div class="input-container salary-input hidden-pdf" id="monthlySalaryContainer">
            <label for="monthlySalary">월급 (₩):</label>
            <input type="number" id="monthlySalary" placeholder="예: 3000000">
        </div>

        <table class="payroll-table">
            <tr>
                <th>출근일수</th>
                <th>총 급여</th>
                <th>세금 (3.3%)</th>
                <th>실수령액</th>
            </tr>
            <tr>
                <td id="attendanceDays">-</td>
                <td id="totalSalary">₩0</td>
                <td id="taxAmount">₩0</td>
                <td id="netSalary">₩0</td>
            </tr>
        </table>

        <!-- ✅ 강조된 직인 스타일 -->
        <div class="signature">맥스체대입시 일산교육원장</div>

        <div class="button-container">
            <button onclick="calculateSalary()">급여 계산</button>
            <button onclick="downloadPDF()">PDF 저장</button>
        </div>
    </div>

    <script>
        async function loadTeachers() {
            const response = await fetch('https://supermax.kr/teachers');
            const teachers = await response.json();
            const teacherSelect = document.getElementById('teacher');

            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.id;
                option.textContent = `${teacher.이름} (${teacher.직급 || '강사'})`;
                option.dataset.role = teacher.직급 || '강사'; 
                teacherSelect.appendChild(option);
            });
        }

        function updateTitle() {
            const teacherName = document.getElementById('teacher').selectedOptions[0].text.split(" ")[0];
            const monthValue = document.getElementById('month').value.split("-")[1] || "월";
            document.getElementById('payroll-title').textContent = `#${teacherName} #${monthValue}월 급여명세서`;
        }

        function toggleSalaryInputs() {
            const role = document.getElementById('teacher').selectedOptions[0].dataset.role;
            document.getElementById('hourlyRateContainer').classList.toggle('hidden-pdf', role === "팀장");
            document.getElementById('dailyRateContainer').classList.toggle('hidden-pdf', role === "팀장");
            document.getElementById('monthlySalaryContainer').classList.toggle('hidden-pdf', role !== "팀장");
        }

        async function calculateSalary() {
            const teacherId = document.getElementById('teacher').value;
            const role = document.getElementById('teacher').selectedOptions[0].dataset.role;
            const monthValue = document.getElementById('month').value;
            const dailyRate = parseFloat(document.getElementById('dailyRate').value);
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value);
            const monthlySalary = parseFloat(document.getElementById('monthlySalary').value);

            if (!teacherId || !monthValue) {
                alert('모든 정보를 입력해주세요.');
                return;
            }

            const [year, month] = monthValue.split('-');
            const response = await fetch(`https://supermax.kr/attendancehistory_monthly?year=${year}&month=${month}`);
            const attendanceRecords = await response.json();
            const attendanceDays = attendanceRecords.filter(record => record.강사_id == teacherId && record.출근 === 1).length;

            let totalSalary = (role === "팀장") ? monthlySalary : attendanceDays * dailyRate;
            const taxAmount = (role === "팀장") ? totalSalary * 0.033 : 0;
            const netSalary = totalSalary - taxAmount;

            document.getElementById('attendanceDays').textContent = attendanceDays;
            document.getElementById('totalSalary').textContent = `₩${totalSalary.toLocaleString()}`;
            document.getElementById('taxAmount').textContent = `₩${taxAmount.toLocaleString()}`;
            document.getElementById('netSalary').textContent = `₩${netSalary.toLocaleString()}`;
        }

        async function downloadPDF() {
            const payrollSection = document.getElementById('payroll-section');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();

            html2canvas(payrollSection).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 10, 10, 180, 0);
                pdf.save('급여명세서.pdf');
            });
        }

        loadTeachers();
    </script>

</body>
</html>
