<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶œê·¼ ê¸°ë¡ ìˆ˜ì •</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
    <style>
        body { font-size: 16px; text-align: center; }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 20px; }
        .day-cell { border: 1px solid #ccc; padding: 10px; min-height: 50px; cursor: pointer; }
        .ì¶œê·¼ { background-color: #D4EDDA; }
        .ì§€ê° { background-color: #FFF3CD; }
        .íœ´ë¬´ { background-color: #F8D7DA; }
        .center { text-align: center; }
        .hidden { display: none; }
        .selected { outline: 3px solid #007BFF; }
        .btn { padding: 10px; font-size: 16px; margin: 5px; cursor: pointer; }
        .attendance-btn { display: inline-block; padding: 10px 15px; margin: 5px; border: none; cursor: pointer; font-size: 14px; }
        .ì¶œê·¼-btn { background-color: #D4EDDA; }
        .ì§€ê°-btn { background-color: #FFF3CD; }
        .íœ´ë¬´-btn { background-color: #F8D7DA; }
    </style>
</head>
<body>
    <h1>ì¶œê·¼ ê¸°ë¡ ìˆ˜ì •</h1>
    <input type="month" id="monthSelect">
    <button class="btn" onclick="generateCalendar()">ì¡°íšŒ</button>
    
    <div class="calendar" id="calendar"></div>

    <div id="attendanceForm" class="hidden">
        <h2 id="selectedDate"></h2>
        <div id="teacherList"></div>
        <button class="btn" onclick="saveAttendance()">ì €ì¥</button>
    </div>

    <script>
async function generateCalendar() {
    const calendar = document.getElementById('calendar');
    calendar.innerHTML = '';

    const monthValue = document.getElementById('monthSelect').value;
    if (!monthValue) {
        alert('ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    const [year, month] = monthValue.split('-');
    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);
    const startWeekDay = firstDay.getDay();
    const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

    // ğŸŸ¢ ìš”ì¼ í—¤ë” ì¶”ê°€
    dayNames.forEach(dayName => {
        const dayHeader = document.createElement('div');
        dayHeader.textContent = dayName;
        dayHeader.style.fontWeight = 'bold';
        dayHeader.classList.add('day-cell');
        calendar.appendChild(dayHeader);
    });

    // ğŸŸ¢ ë¹ˆ ì¹¸ ì¶”ê°€ (ì›” ì‹œì‘ ìš”ì¼ ë§ì¶”ê¸°)
    for (let i = 0; i < startWeekDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.classList.add('day-cell');
        calendar.appendChild(emptyCell);
    }

    let records = [];
    try {
        const response = await fetch(`https://supermax.kr/attendancehistory?year=${year}&month=${month}`);
        if (!response.ok) {
            throw new Error('ì¶œê·¼ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

        records = await response.json();
        console.log(`âœ… ${year}-${month} ì¶œê·¼ ê¸°ë¡:`, records);
    } catch (error) {
        console.error('ì¶œê·¼ ê¸°ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
        alert('ì¶œê·¼ ê¸°ë¡ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }

    if (!Array.isArray(records)) {
        console.error('âŒ ì¶œê·¼ ê¸°ë¡ ë°ì´í„°ê°€ ë°°ì—´ì´ ì•„ë‹˜:', records);
        records = [];
    }

    // ğŸŸ¢ ë‚ ì§œ ì…€ ì¶”ê°€
    for (let i = 1; i <= lastDay.getDate(); i++) {
        const cell = document.createElement('div');
        cell.classList.add('day-cell');
        cell.textContent = i;

        // ğŸŸ¢ í˜„ì¬ ë‚ ì§œ (YYYY-MM-DD í˜•ì‹)
        const currentDate = `${year}-${String(month).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
        
        // ğŸŸ¢ ì¶œê·¼ ê¸°ë¡ í•„í„°ë§
        const record = records.find(r => r.ì¶œê·¼ì¼ === currentDate);
        if (record) {
            if (Number(record.ì¶œê·¼) === 1) cell.classList.add('ì¶œê·¼');
            if (Number(record.ì§€ê°) === 1) cell.classList.add('ì§€ê°');
            if (Number(record.íœ´ë¬´) === 1) cell.classList.add('íœ´ë¬´');
        }

        cell.onclick = () => openAttendanceForm(currentDate);
        calendar.appendChild(cell);
    }
}

        async function openAttendanceForm(date) {
            document.getElementById('selectedDate').textContent = `${date} ì¶œê·¼ ì²´í¬`;
            document.getElementById('attendanceForm').classList.remove('hidden');

            const response = await fetch('https://supermax.kr/teachers');
            const teachers = await response.json();
            const listContainer = document.getElementById('teacherList');
            listContainer.innerHTML = '';

            const recordsResponse = await fetch(`https://supermax.kr/attendancehistory?date=${date}`);
            const records = await recordsResponse.json();

            teachers.forEach(teacher => {
                const record = records.find(r => r.ê°•ì‚¬_id == teacher.id);
                let initialStatus = '';

                if (record) {
                    if (record.ì¶œê·¼) initialStatus = 'ì¶œê·¼';
                    else if (record.ì§€ê°) initialStatus = 'ì§€ê°';
                    else if (record.íœ´ë¬´) initialStatus = 'íœ´ë¬´';
                }

                const div = document.createElement('div');
                div.innerHTML = `
                    <p>${teacher.ì´ë¦„} (${teacher.ì§ê¸‰ || 'ì§ê¸‰ ì—†ìŒ'})</p>
                    <button class="attendance-btn ì¶œê·¼-btn" data-teacher-id="${teacher.id}" data-status="ì¶œê·¼" onclick="setAttendance(this)">ì¶œê·¼</button>
                    <button class="attendance-btn ì§€ê°-btn" data-teacher-id="${teacher.id}" data-status="ì§€ê°" onclick="setAttendance(this)">ì§€ê°</button>
                    <button class="attendance-btn íœ´ë¬´-btn" data-teacher-id="${teacher.id}" data-status="íœ´ë¬´" onclick="setAttendance(this)">íœ´ë¬´</button>
                `;
                listContainer.appendChild(div);

                if (initialStatus) {
                    div.querySelector(`[data-status="${initialStatus}"]`).style.opacity = "0.6";
                }
            });
        }

        function setAttendance(button) {
            const teacherId = button.getAttribute('data-teacher-id');
            const buttons = document.querySelectorAll(`button[data-teacher-id="${teacherId}"]`);
            buttons.forEach(btn => btn.style.opacity = "1");
            button.style.opacity = "0.6";
        }

        async function saveAttendance() {
            const selectedDate = document.getElementById('selectedDate').textContent.split(' ')[0];
            const attendanceData = [];

            document.querySelectorAll('.attendance-btn[style*="opacity: 0.6"]').forEach(btn => {
                const ê°•ì‚¬_id = btn.getAttribute('data-teacher-id');
                const ìƒíƒœ = btn.getAttribute('data-status');
                attendanceData.push({ ê°•ì‚¬_id, ì¶œê·¼ì¼: selectedDate, ìƒíƒœ });
            });

            if (attendanceData.length === 0) {
                alert('ì¶œê·¼ ìƒíƒœë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            const response = await fetch('https://supermax.kr/attendancecheckedit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(attendanceData)
            });

            const result = await response.json();
            alert(result.message);

            // âœ… ì €ì¥ í›„ ë‹¬ë ¥ ì¦‰ì‹œ ê°±ì‹ 
            generateCalendar();
        }
    </script>
</body>
</html>
