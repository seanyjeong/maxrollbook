<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶œê·¼ ê¸°ë¡ ìˆ˜ì •</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
    <style>
        body { font-size: 16px; text-align: center; }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 20px; }
        .day-cell { border: 1px solid #ccc; padding: 10px; min-height: 50px; cursor: pointer; }
        .legend { margin-top: 10px; }
        .ì¶œê·¼ { background-color: #D4EDDA; }
        .ì§€ê° { background-color: #FFF3CD; }
        .íœ´ë¬´ { background-color: #F8D7DA; }
        .center { text-align: center; }
        .hidden { display: none; }
        .status-container { display: flex; justify-content: center; gap: 10px; margin: 10px 0; }
        .status-btn {
            padding: 10px 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .ì¶œê·¼-btn { background-color: #D4EDDA; }
        .ì§€ê°-btn { background-color: #FFF3CD; }
        .íœ´ë¬´-btn { background-color: #F8D7DA; }
        .btn-selected { outline: 3px solid black; }
        .work-hour-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
}
.work-hour-container input {
    width: 60px;
    text-align: center;
}

    </style>
</head>
<body>
    <h1>ì¶œê·¼ ê¸°ë¡ ìˆ˜ì •</h1>
    <input type="month" id="monthSelect">
    <button onclick="generateCalendar()">ì¡°íšŒ</button>
    <div class="calendar" id="calendar"></div>
    
<div id="attendanceForm" class="hidden">
    <h2 id="selectedDate"></h2>
    <div id="teacherList"></div>
    <h3>ê·¼ë¬´ì‹œê°„ ì…ë ¥</h3>

    <button onclick="saveAttendance()">ì €ì¥</button>
</div>


    <script>
async function generateCalendar() {
    const calendar = document.getElementById('calendar');
    calendar.innerHTML = '';

    const monthValue = document.getElementById('monthSelect').value;
    if (!monthValue) {
        alert('ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    const [year, month] = monthValue.split('-');

    // âœ… í•œ ë‹¬ ì „ì²´ ì¶œê·¼ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    const response = await fetch(`https://supermax.kr/attendancehistory_monthly?year=${year}&month=${month}`);
    const attendanceRecords = await response.json();
    console.log(`ğŸ“¢ ${month}ì›” ì¶œê·¼ ê¸°ë¡:`, attendanceRecords);

    const attendanceMap = {};
    attendanceRecords.forEach(record => {
        // âœ… KST ë³€í™˜ (UTC â†’ KST 9ì‹œê°„ ì¶”ê°€)
        const ì¶œê·¼ì¼ = new Date(new Date(record.ì¶œê·¼ì¼).getTime() + (9 * 60 * 60 * 1000))
            .toISOString()
            .split('T')[0];

        if (!attendanceMap[ì¶œê·¼ì¼]) {
            attendanceMap[ì¶œê·¼ì¼] = { ì¶œê·¼: 0, ì§€ê°: 0, íœ´ë¬´: 0 };
        }
        if (record.ì¶œê·¼ === 1) attendanceMap[ì¶œê·¼ì¼].ì¶œê·¼ = 1;
        if (record.ì§€ê° === 1) attendanceMap[ì¶œê·¼ì¼].ì§€ê° = 1;
        if (record.íœ´ë¬´ === 1) attendanceMap[ì¶œê·¼ì¼].íœ´ë¬´ = 1;
    });

    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);
    const startWeekDay = firstDay.getDay();
    const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

    // ìš”ì¼ í—¤ë” ì¶”ê°€
    dayNames.forEach(dayName => {
        const dayHeader = document.createElement('div');
        dayHeader.textContent = dayName;
        dayHeader.style.fontWeight = 'bold';
        dayHeader.classList.add('day-cell');
        calendar.appendChild(dayHeader);
    });

    // ë¹ˆ ì¹¸ ì±„ìš°ê¸°
    for (let i = 0; i < startWeekDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.classList.add('day-cell');
        calendar.appendChild(emptyCell);
    }

    // ë‚ ì§œ ì…€ ì¶”ê°€
    for (let i = 1; i <= lastDay.getDate(); i++) {
        const dateStr = `${year}-${month.padStart(2, '0')}-${String(i).padStart(2, '0')}`;
        const cell = document.createElement('div');
        cell.classList.add('day-cell');
        cell.textContent = i;

        // âœ… ì¶œê·¼ ê¸°ë¡ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ìƒ‰ìƒ ì ìš©
        if (attendanceMap[dateStr]) {
            const ê¸°ë¡ = attendanceMap[dateStr];
            if (ê¸°ë¡.ì¶œê·¼ === 1) {
                cell.classList.add('ì¶œê·¼');
            } else if (ê¸°ë¡.ì§€ê° === 1) {
                cell.classList.add('ì§€ê°');
            } else if (ê¸°ë¡.íœ´ë¬´ === 1) {
                cell.classList.add('íœ´ë¬´');
            }
        }

        cell.onclick = () => openAttendanceForm(dateStr);
        calendar.appendChild(cell);
    }
}



   async function openAttendanceForm(date) {
    document.getElementById('selectedDate').textContent = `${date} ì¶œê·¼ ì²´í¬`;
    document.getElementById('attendanceForm').classList.remove('hidden');

    const response = await fetch('https://supermax.kr/teachers');
    const teachers = await response.json();
    const attendanceResponse = await fetch(`https://supermax.kr/attendancehistory?date=${date}`);
    const attendanceRecords = await attendanceResponse.json();
    console.log(`ğŸ“¢ ë¶ˆëŸ¬ì˜¨ ì¶œê·¼ ê¸°ë¡:`, attendanceRecords);

    const listContainer = document.getElementById('teacherList');
    listContainer.innerHTML = '';

    teachers.forEach(teacher => {
        const record = attendanceRecords.find(r => r.ê°•ì‚¬_id == teacher.id);
        let ìƒíƒœê°’ = "";
        let ê·¼ë¬´ì‹œê°„ = record ? record.ê·¼ë¬´ì‹œê°„ || 0 : 0; // âœ… ê·¼ë¬´ì‹œê°„ ê°€ì ¸ì˜¤ê¸°

        if (record) {
            if (Number(record.ì¶œê·¼) === 1) ìƒíƒœê°’ = "ì¶œê·¼";
            else if (Number(record.ì§€ê°) === 1) ìƒíƒœê°’ = "ì§€ê°";
            else if (Number(record.íœ´ë¬´) === 1) ìƒíƒœê°’ = "íœ´ë¬´";
        }

   const div = document.createElement('div');
div.innerHTML = `
    <p>${teacher.ì´ë¦„} (${teacher.ì§ê¸‰ || 'ì§ê¸‰ ì—†ìŒ'})</p>
    <div class="status-container">
        <button class="status-btn ì¶œê·¼-btn ${ìƒíƒœê°’ === 'ì¶œê·¼' ? 'btn-selected' : ''}" onclick="selectStatus(this, 'ì¶œê·¼')" data-teacher-id="${teacher.id}">ì¶œê·¼</button>
        <button class="status-btn ì§€ê°-btn ${ìƒíƒœê°’ === 'ì§€ê°' ? 'btn-selected' : ''}" onclick="selectStatus(this, 'ì§€ê°')" data-teacher-id="${teacher.id}">ì§€ê°</button>
        <button class="status-btn íœ´ë¬´-btn ${ìƒíƒœê°’ === 'íœ´ë¬´' ? 'btn-selected' : ''}" onclick="selectStatus(this, 'íœ´ë¬´')" data-teacher-id="${teacher.id}">íœ´ë¬´</button>
    </div>
    <div class="work-hour-container">
        <label>ê·¼ë¬´ì‹œê°„:</label>
        <input type="number" class="workHours" data-teacher-id="${teacher.id}" value="${record?.ê·¼ë¬´ì‹œê°„ || 0}" step="0.5" min="0">
        <span>ì‹œê°„</span>
    </div>
`;

        listContainer.appendChild(div);
    });
}

        function selectStatus(button, status) {
            const parent = button.parentNode;
            parent.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('btn-selected'));
            button.classList.add('btn-selected');
        }

   async function saveAttendance() {
    const selects = document.querySelectorAll('.btn-selected');
    const attendanceData = [];

    selects.forEach(button => {
        const ìƒíƒœ = button.textContent;
        const ê°•ì‚¬_id = button.getAttribute('data-teacher-id');
        const ì¶œê·¼ì¼ = document.getElementById('selectedDate').textContent.split(' ')[0];

        // âœ… í•´ë‹¹ ê°•ì‚¬ì˜ ê·¼ë¬´ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
        const ê·¼ë¬´ì‹œê°„Input = document.querySelector(`.workHours[data-teacher-id="${ê°•ì‚¬_id}"]`);
        const ê·¼ë¬´ì‹œê°„ = ê·¼ë¬´ì‹œê°„Input ? parseFloat(ê·¼ë¬´ì‹œê°„Input.value) || 0 : 0;

        attendanceData.push({ ê°•ì‚¬_id, ì¶œê·¼ì¼, ìƒíƒœ, ê·¼ë¬´ì‹œê°„ });
    });

    await fetch('https://supermax.kr/attendancecheck', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(attendanceData)
    });

    alert('âœ… ì¶œê·¼ ê¸°ë¡ ì €ì¥ ì™„ë£Œ!');
}

    </script>
        <footer style="margin-top: 20px; text-align: center; font-size: 12px; color: #666;">
            &copy; 2025 ì¼ì‚°ë§¥ìŠ¤ ê°•ì‚¬ ì¶œê·¼ë¶€ ì‹œìŠ¤í…œ BY ì •ì›ì¥
        </footer>
</body>
</html>