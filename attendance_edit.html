<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶œê·¼ ê¸°ë¡ ìˆ˜ì •</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
    <style>
        body { font-size: 16px; text-align: center; }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 20px; }
        .day-cell { border: 1px solid #ccc; padding: 10px; min-height: 50px; cursor: pointer; }
        .legend { margin-top: 10px; }
        .ì¶œê·¼ { background-color: #D4EDDA; }
        .ì§€ê° { background-color: #FFF3CD; }
        .íœ´ë¬´ { background-color: #F8D7DA; }
        .center { text-align: center; }
        .hidden { display: none; }
        select, button { margin: 5px; padding: 8px; font-size: 16px; }

        /* ì¶œê·¼ ìƒíƒœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .status-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .status-btn {
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            border-radius: 5px;
            transition: all 0.3s ease-in-out;
            filter: brightness(90%);
        }
        .ì¶œê·¼-btn { background-color: #A8E6A1; } /* ì—°í•œ ì´ˆë¡ */
        .ì§€ê°-btn { background-color: #FFE699; } /* ì—°í•œ ë…¸ë‘ */
        .íœ´ë¬´-btn { background-color: #FFB3B3; } /* ì—°í•œ ë¹¨ê°• */

        /* ì„ íƒëœ ë²„íŠ¼ì€ ê°•ì¡° */
        .ì¶œê·¼-btn.btn-selected { background-color: #28a745; filter: brightness(110%); }
        .ì§€ê°-btn.btn-selected { background-color: #ffc107; filter: brightness(110%); }
        .íœ´ë¬´-btn.btn-selected { background-color: #dc3545; filter: brightness(110%); }
    </style>
</head>
<body>
    <h1>ì¶œê·¼ ê¸°ë¡ ìˆ˜ì •</h1>
    <input type="month" id="monthSelect">
    <button onclick="generateCalendar()">ì¡°íšŒ</button>
    <div class="calendar" id="calendar"></div>
    
    <div id="attendanceForm" class="hidden">
        <h2 id="selectedDate"></h2>
        <div id="teacherList"></div>
        <button onclick="saveAttendance()">ì €ì¥</button>
    </div>

    <script>
        function generateCalendar() {
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';
            
            const monthValue = document.getElementById('monthSelect').value;
            if (!monthValue) {
                alert('ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const [year, month] = monthValue.split('-');
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const startWeekDay = firstDay.getDay();
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            
            // ğŸŸ¢ ìš”ì¼ í‘œì‹œ ì¶”ê°€
            dayNames.forEach(dayName => {
                const dayHeader = document.createElement('div');
                dayHeader.textContent = dayName;
                dayHeader.style.fontWeight = 'bold';
                dayHeader.classList.add('day-cell');
                calendar.appendChild(dayHeader);
            });

            // ğŸŸ¢ ë‹¬ë ¥ ë¹ˆ ì¹¸ ì±„ìš°ê¸°
            for (let i = 0; i < startWeekDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('day-cell');
                calendar.appendChild(emptyCell);
            }
            
            for (let i = 1; i <= lastDay.getDate(); i++) {
                const cell = document.createElement('div');
                cell.classList.add('day-cell');
                cell.textContent = i;
                cell.onclick = () => openAttendanceForm(`${year}-${month.padStart(2, '0')}-${String(i).padStart(2, '0')}`);
                calendar.appendChild(cell);
            }
        }

        async function openAttendanceForm(date) {
            document.getElementById('selectedDate').textContent = `${date} ì¶œê·¼ ì²´í¬`;
            document.getElementById('attendanceForm').classList.remove('hidden');
            
            // ğŸŸ¢ ê°•ì‚¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            const response = await fetch('https://supermax.kr/teachers');
            const teachers = await response.json();
            const listContainer = document.getElementById('teacherList');
            listContainer.innerHTML = '';

            // ğŸŸ¢ ê¸°ì¡´ ì¶œê·¼ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            const attendanceResponse = await fetch(`https://supermax.kr/attendanceteacher?id=all&date=${date}`);
            const attendanceRecords = await attendanceResponse.json();
            console.log(`âœ… ${date}ì˜ ê¸°ì¡´ ì¶œê·¼ ê¸°ë¡:`, attendanceRecords);

            teachers.forEach(teacher => {
                const record = attendanceRecords.find(r => r.ê°•ì‚¬_id == teacher.id);
                let ìƒíƒœê°’ = "";

                if (record) {
                    if (Number(record.ì¶œê·¼) === 1) ìƒíƒœê°’ = "ì¶œê·¼";
                    else if (Number(record.ì§€ê°) === 1) ìƒíƒœê°’ = "ì§€ê°";
                    else if (Number(record.íœ´ë¬´) === 1) ìƒíƒœê°’ = "íœ´ë¬´";
                }

                const div = document.createElement('div');
                div.innerHTML = `
                    <p>${teacher.ì´ë¦„} (${teacher.ì§ê¸‰ || 'ì§ê¸‰ ì—†ìŒ'})</p>
                    <div class="status-container">
                        <button class="status-btn ì¶œê·¼-btn ${ìƒíƒœê°’ === 'ì¶œê·¼' ? 'btn-selected' : ''}" onclick="selectStatus(this, 'ì¶œê·¼')" data-teacher-id="${teacher.id}">ì¶œê·¼</button>
                        <button class="status-btn ì§€ê°-btn ${ìƒíƒœê°’ === 'ì§€ê°' ? 'btn-selected' : ''}" onclick="selectStatus(this, 'ì§€ê°')" data-teacher-id="${teacher.id}">ì§€ê°</button>
                        <button class="status-btn íœ´ë¬´-btn ${ìƒíƒœê°’ === 'íœ´ë¬´' ? 'btn-selected' : ''}" onclick="selectStatus(this, 'íœ´ë¬´')" data-teacher-id="${teacher.id}">íœ´ë¬´</button>
                    </div>
                `;
                listContainer.appendChild(div);
            });
        }

        function selectStatus(button, status) {
            const teacherId = button.getAttribute('data-teacher-id');

            // ëª¨ë“  ë²„íŠ¼ì—ì„œ ì„ íƒëœ ìƒíƒœ ì œê±°
            document.querySelectorAll(`.status-btn[data-teacher-id="${teacherId}"]`).forEach(btn => {
                btn.classList.remove('btn-selected');
                btn.style.filter = "brightness(90%)"; // ì„ íƒ í•´ì œ ì‹œ ë°ê¸° ë‚®ì¶”ê¸°
            });

            // í˜„ì¬ ì„ íƒí•œ ë²„íŠ¼ë§Œ ê°•ì¡°
            button.classList.add('btn-selected');
            button.style.filter = "brightness(110%)"; // ì„ íƒëœ ë²„íŠ¼ ë°ê¸° ì¦ê°€
        }
        
        async function saveAttendance() {
            const attendanceData = [];
            
            document.querySelectorAll('.status-btn.btn-selected').forEach(button => {
                const ìƒíƒœ = button.textContent;
                const ê°•ì‚¬_id = button.getAttribute('data-teacher-id');
                const ì¶œê·¼ì¼ = document.getElementById('selectedDate').textContent.split(' ')[0];
                
                attendanceData.push({ ê°•ì‚¬_id, ì¶œê·¼ì¼, ìƒíƒœ });
            });

            if (attendanceData.length === 0) {
                alert('ì¶œê·¼ ìƒíƒœë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            const response = await fetch('https://supermax.kr/attendancecheck', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(attendanceData)
            });

            const result = await response.json();
            alert(result.message);
        }
    </script>
</body>
</html>
