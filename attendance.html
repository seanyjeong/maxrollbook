<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶œì„ ì²´í¬</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        table { width: 90%; margin: 20px auto; border-collapse: collapse; }
        th, td { padding: 10px; border: 1px solid black; text-align: center; }
        input, button, select { padding: 8px; margin: 5px; font-size: 16px; }
        .date-header { font-size: 20px; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h2>ì¶œì„ ì²´í¬</h2>
    <div class="date-header" id="currentDate"></div>

    <table id="attendanceTable">
        <thead>
            <tr>
                <th>ì´ë¦„</th>
                <th>ì¶œì„</th>
                <th>ì§€ê°</th>
                <th>ê²°ì„</th>
                <th>ì‚¬ìœ </th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button onclick="saveAttendance()">ì¶œì„ ì €ì¥</button>

    <script>
        const API_URL = "https://supermax.kr";

        // âœ… ì˜¤ëŠ˜ ë‚ ì§œ ë° ìš”ì¼ í‘œì‹œ
        function updateDate() {
            const today = new Date();
            const dayNames = ["ì¼ìš”ì¼", "ì›”ìš”ì¼", "í™”ìš”ì¼", "ìˆ˜ìš”ì¼", "ëª©ìš”ì¼", "ê¸ˆìš”ì¼", "í† ìš”ì¼"];
            document.getElementById("currentDate").innerText = 
                `${today.toLocaleDateString()} (${dayNames[today.getDay()]})`;
        }
        updateDate();

        async function fetchAttendanceData() {
            try {
                const response = await fetch(API_URL + "/attendancetoday");
                const students = await response.json();
                renderAttendance(students);
            } catch (error) {
                console.error("ì¶œì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            }
        }

        // âœ… ì¶œì„ ë°ì´í„° í…Œì´ë¸” ë Œë”ë§
        function renderAttendance(students) {
            let tableContent = "";
            students.forEach((student, index) => {
                tableContent += `
                    <tr data-id="${student.id}">
                        <td>${student.ì´ë¦„}</td>
                        <td><input type="radio" name="status-${index}" value="ì¶œì„"></td>
                        <td><input type="radio" name="status-${index}" value="ì§€ê°"></td>
                        <td><input type="radio" name="status-${index}" value="ê²°ì„"></td>
                        <td><input type="text" id="reason-${index}" value="${student.ì‚¬ìœ  || ""}"></td>
                    </tr>
                `;
            });

            document.querySelector("#attendanceTable tbody").innerHTML = tableContent;
        }

        // âœ… ì¶œì„ ë°ì´í„° ì €ì¥ (ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ì— ë§ê²Œ ìˆ˜ì •)
  async function saveAttendance() {
    const rows = document.querySelectorAll("#attendanceTable tbody tr");
    let data = [];

    rows.forEach((row, index) => {
        const studentId = parseInt(row.getAttribute("data-id"), 10); // âœ… ì •ìˆ˜ ë³€í™˜
        const selectedStatus = document.querySelector(`input[name="status-${index}"]:checked`);

        if (!selectedStatus) {
            alert("ì¶œì„ ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
            return;
        }

        const reason = document.getElementById(`reason-${index}`).value;

        // âœ… ì„œë²„ê°€ ìš”êµ¬í•˜ëŠ” Boolean í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        let attendance = false, late = false, absent = false;
        if (selectedStatus.value === "ì¶œì„") attendance = true;
        if (selectedStatus.value === "ì§€ê°") late = true;
        if (selectedStatus.value === "ê²°ì„") absent = true;

        data.push({ 
            í•™ìƒ_id: studentId, 
            attendance: attendance, 
            late: late, 
            absent: absent,
            reason: reason
        });
    });

    console.log("ğŸ“Œ ì„œë²„ë¡œ ì „ì†¡í•  ì¶œì„ ë°ì´í„°:", JSON.stringify(data)); // âœ… ì „ì†¡ ë°ì´í„° ë¡œê·¸ í™•ì¸

    try {
        const response = await fetch(API_URL + "/attendancerecord", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
        });

        if (!response.ok) {
            const errorText = await response.text(); // ì„œë²„ ì‘ë‹µ í™•ì¸
            throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${errorText}`);
        }

        alert("ì¶œì„ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
    } catch (error) {
        console.error("ì¶œì„ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        alert("ì €ì¥ ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
}


        // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ì¶œì„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        fetchAttendanceData();
    </script>

</body>
</html>
