<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>출석 체크</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
</head>
<body>
    <h2>오늘 출석 체크</h2>
    <div id="attendance-list">로딩 중...</div>
    <button onclick="submitAttendance()">출석 저장</button>
    
    <script>
        const API_URL = "https://supermax.kr";
        let attendanceData = [];

        async function fetchAttendanceList() {
            try {
                const response = await fetch(`${API_URL}/attendancetoday`);
                const data = await response.json();
                renderAttendanceList(data);
            } catch (error) {
                document.getElementById("attendance-list").innerText = "데이터를 불러올 수 없습니다.";
                console.error("출석 목록 조회 오류:", error);
            }
        }

        function renderAttendanceList(data) {
            const list = document.getElementById("attendance-list");
            list.innerHTML = "";
            attendanceData = data;

            data.forEach((student, index) => {
                const div = document.createElement("div");
                div.innerHTML = `
                    <strong>${student.이름} (${student.학교} ${student.학년}학년)</strong><br>
                    <label><input type="radio" name="status-${index}" value="출석" ${student.출석상태 === "출석" ? "checked" : ""}> 출석</label>
                    <label><input type="radio" name="status-${index}" value="지각" ${student.출석상태 === "지각" ? "checked" : ""}> 지각</label>
                    <label><input type="radio" name="status-${index}" value="결석" ${student.출석상태 === "결석" ? "checked" : ""}> 결석</label><br>
                    <input type="text" id="reason-${index}" placeholder="사유 (선택)" value="${student.사유 || ''}">
                `;
                list.appendChild(div);
            });
        }

        async function submitAttendance() {
            const submitData = attendanceData.map((student, index) => {
                const status = document.querySelector(`input[name='status-${index}']:checked`).value;
                const reason = document.getElementById(`reason-${index}`).value;
                return { 학생_id: student.id, 출석상태: status, 사유: reason || null };
            });

            try {
                const response = await fetch(`${API_URL}/attendancerecord`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(submitData),
                });
                const result = await response.json();
                alert(result.message);
                fetchAttendanceList(); // 업데이트 후 목록 새로고침
            } catch (error) {
                alert("출석 저장 실패");
                console.error("출석 체크 저장 오류:", error);
            }
        }

        fetchAttendanceList();
    </script>
</body>
</html>
