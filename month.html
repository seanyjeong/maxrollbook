<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶œì„ë¶€ ë‹¬ë ¥</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
    <style>
        body { text-align: center; }
        .calendar-container {
            max-width: 400px;
            margin: auto;
        }
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        .day, .weekday {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
            font-size: 14px;
        }
        .weekday {
            font-weight: bold;
            background: #f0f0f0;
        }
        .day {
            cursor: pointer;
        }
        .day:hover {
            background-color: #f0f0f0;
        }
        .stats {
            font-size: 12px;
            color: #555;
        }
        .selected-day {
            background-color: #007BFF;
            color: white;
        }
        .attendance-list {
            text-align: left;
            max-width: 400px;
            margin: 20px auto;
        }
        .attendance-list ul {
            list-style-type: none;
            padding: 0;
        }
    </style>
</head>
<body>

    <h2>ì¶œì„ë¶€ ë‹¬ë ¥</h2>

    <!-- ì›” ì„ íƒ -->
    <label>ì›” ì„ íƒ:
        <input type="month" id="monthPicker">
    </label>
    
    <div class="calendar-container">
        <div class="calendar" id="calendar">
            <!-- ìš”ì¼ í‘œì‹œ -->
            <div class="weekday">ì¼</div>
            <div class="weekday">ì›”</div>
            <div class="weekday">í™”</div>
            <div class="weekday">ìˆ˜</div>
            <div class="weekday">ëª©</div>
            <div class="weekday">ê¸ˆ</div>
            <div class="weekday">í† </div>
        </div>
    </div>

    <h3 id="selectedDateTitle"></h3>
    <div class="attendance-list" id="attendanceDetails"></div>

    <script>
        const API_BASE = "https://supermax.kr";
        const calendar = document.getElementById("calendar");
        const monthPicker = document.getElementById("monthPicker");
        const selectedDateTitle = document.getElementById("selectedDateTitle");
        const attendanceDetails = document.getElementById("attendanceDetails");

        // í˜„ì¬ ì›” ì„¤ì •
        const today = new Date();
        monthPicker.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        loadCalendarData();

        // ì›” ë³€ê²½ ì‹œ ë°ì´í„° ë¡œë“œ
        monthPicker.addEventListener("change", loadCalendarData);

        async function loadCalendarData() {
            const [year, month] = monthPicker.value.split("-");
            const response = await fetch(`${API_BASE}/attendancemonth?year=${year}&month=${month}`);
            const attendanceData = await response.json();
            
            renderCalendar(year, month, attendanceData);
        }

        function renderCalendar(year, month, attendanceData) {
            // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™” í›„ ìš”ì¼ ì¶”ê°€
            calendar.innerHTML = `
                <div class="weekday">ì¼</div><div class="weekday">ì›”</div><div class="weekday">í™”</div>
                <div class="weekday">ìˆ˜</div><div class="weekday">ëª©</div><div class="weekday">ê¸ˆ</div><div class="weekday">í† </div>
            `;

            const firstDay = new Date(year, month - 1, 1).getDay(); // 0 (ì¼) ~ 6 (í† )
            const lastDate = new Date(year, month, 0).getDate(); // ì›”ì˜ ë§ˆì§€ë§‰ ë‚ ì§œ
            
            // ë¹ˆ ì¹¸ ì¶”ê°€ (í•´ë‹¹ ì›”ì˜ ì‹œì‘ ìš”ì¼ ë§ì¶”ê¸°)
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement("div");
                calendar.appendChild(emptyCell);
            }

            // ë‚ ì§œ ì±„ìš°ê¸°
            for (let date = 1; date <= lastDate; date++) {
                const dayElement = document.createElement("div");
                dayElement.classList.add("day");
                dayElement.textContent = date;

                const fullDate = `${year}-${month.padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                const attendanceInfo = attendanceData.find(d => d.ì¶œì„ì¼ === fullDate);

                if (attendanceInfo) {
                    const stats = document.createElement("div");
                    stats.className = "stats";
                    stats.innerHTML = `
                        ì¶œì„: ${attendanceInfo.ì¶œì„} | 
                        ì§€ê°: ${attendanceInfo.ì§€ê°} | 
                        ê²°ì„: ${attendanceInfo.ê²°ì„}
                    `;
                    dayElement.appendChild(stats);
                }

                dayElement.addEventListener("click", () => loadAttendanceDetails(fullDate, dayElement));

                calendar.appendChild(dayElement);
            }
        }

async function loadAttendanceDetails(date, selectedDay) {
    document.querySelectorAll(".day").forEach(d => d.classList.remove("selected-day"));
    selectedDay.classList.add("selected-day");
    selectedDateTitle.textContent = `ğŸ“… ${date} ì¶œì„ ìƒì„¸`;

    const response = await fetch(`${API_BASE}/attendanceday?date=${date}`);
    const { totalStudents, students } = await response.json();
    const dayOfWeek = new Date(date).getDay(); // 0 (ì¼) ~ 6 (í† )

    // âœ… í•´ë‹¹ ìš”ì¼ ì¶œì„ ëŒ€ìƒ í•™ìƒ í•„í„°ë§
    const filteredStudents = students.filter(s => {
        const attendKey = ['ì¶œì„_ì¼', 'ì¶œì„_ì›”', 'ì¶œì„_í™”', 'ì¶œì„_ìˆ˜', 'ì¶œì„_ëª©', 'ì¶œì„_ê¸ˆ', 'ì¶œì„_í† '][dayOfWeek];
        return s[attendKey] === 1;
    });

    // âœ… ì´ ì¶œì„ ëŒ€ìƒ ì¸ì› ìˆ˜ ê³„ì‚°
    const totalAttendance = filteredStudents.length;

    attendanceDetails.innerHTML = `
        <h4>ì´ ì¶œì„ ëŒ€ìƒ: ${totalAttendance}ëª…</h4>
        <ul>
            ${filteredStudents.length > 0 ? 
                filteredStudents.map(s => `
                    <li><strong>${s.ì´ë¦„}</strong> (${s.í•™êµ}, ${s.í•™ë…„}í•™ë…„) - 
                    <span style="color: ${s.ì¶œì„ìƒíƒœ === 'ì¶œì„' ? 'green' : (s.ì¶œì„ìƒíƒœ === 'ì§€ê°' ? 'orange' : 'red')}">
                        ${s.ì¶œì„ìƒíƒœ || 'ë¯¸ì…ë ¥'}
                    </span> 
                    ${s.ì‚¬ìœ  ? `(${s.ì‚¬ìœ })` : ""}
                    </li>
                `).join("") 
                : `<li>í•´ë‹¹ ìš”ì¼ì— ì¶œì„í•´ì•¼ í•  í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</li>`
            }
        </ul>
    `;
}

    </script>

</body>
</html>
