<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ ì›”ë³„ ì¶œì„í˜„í™©</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
    <style>
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .day, .weekday {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .weekday {
            font-weight: bold;
            background: #f0f0f0;
        }
        .day.attend { background-color: #d4edda; } /* ì¶œì„ */
        .day.late { background-color: #fff3cd; }    /* ì§€ê° */
        .day.absent { background-color: #f8d7da; }  /* ê²°ì„ */
        .day:hover { cursor: pointer; background-color: #f1f1f1; }
        .summary { margin-top: 10px; font-size: 14px; }
    </style>
</head>
<body>

    <h2>í•™ìƒ ì›”ë³„ ì¶œì„í˜„í™©</h2>

    <label for="studentSelect">í•™ìƒ ì„ íƒ:</label>
    <select id="studentSelect"></select>

    <label for="monthSelect">ì›” ì„ íƒ:</label>
    <input type="month" id="monthSelect">

    <div class="calendar" id="calendar"></div>

    <div id="hoverInfo" class="summary"></div>
    <div id="monthSummary" class="summary"></div>

    <script>
        const API_BASE = "https://supermax.kr";

        const studentSelect = document.getElementById("studentSelect");
        const monthSelect = document.getElementById("monthSelect");
        const calendar = document.getElementById("calendar");
        const hoverInfo = document.getElementById("hoverInfo");
        const monthSummary = document.getElementById("monthSummary");

        async function loadStudents() {
            const res = await fetch(`${API_BASE}/adminstudents`);
            const students = await res.json();

            studentSelect.innerHTML = `<option value="">í•™ìƒ ì„ íƒ</option>`;
            students.forEach(student => {
                const option = document.createElement("option");
                option.value = student.id;
                option.textContent = `${student.ì´ë¦„} (${student.í•™êµ}, ${student.í•™ë…„}í•™ë…„)`;
                studentSelect.appendChild(option);
            });
        }

async function loadAttendance(studentId, year, month) {
    console.log(`ğŸ“¡ ìš”ì²­ ì¤‘... í•™ìƒID: ${studentId}, ë…„ë„: ${year}, ì›”: ${month}`);

    try {
        const res = await fetch(`${API_BASE}/attendancemonthstudent?year=${year}&month=${month}&studentId=${studentId}`);
        const attendanceData = await res.json();

        console.log(`âœ… ì‘ë‹µ ë°ì´í„° (${studentId}):`, attendanceData);

        renderCalendar(year, month, attendanceData);
    } catch (error) {
        console.error(`âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (${studentId}):`, error);
    }
}

        function renderCalendar(year, month, attendanceData) {
            calendar.innerHTML = '';

            const firstDay = new Date(year, month - 1, 1).getDay();
            const lastDate = new Date(year, month, 0).getDate();

            // ìš”ì¼ í—¤ë” ì¶”ê°€
            ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].forEach(day => {
                const div = document.createElement('div');
                div.className = 'weekday';
                div.textContent = day;
                calendar.appendChild(div);
            });

            // ë¹ˆì¹¸ ì±„ìš°ê¸° (ì²«ì§¸ ë‚  ìœ„ì¹˜ ë§ì¶”ê¸°)
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                calendar.appendChild(emptyCell);
            }

            let attendCount = 0, lateCount = 0, absentCount = 0, totalDays = 0;

            for (let date = 1; date <= lastDate; date++) {
                const fullDate = `${year}-${String(month).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                const record = attendanceData.find(r => r.ì¶œì„ì¼ === fullDate);

                const dayCell = document.createElement('div');
                dayCell.classList.add('day');
                dayCell.textContent = date;

                if (record) {
                    totalDays++;
                    if (record.ì¶œì„ìƒíƒœ === 'ì¶œì„') {
                        dayCell.classList.add('attend');
                        attendCount++;
                    } else if (record.ì¶œì„ìƒíƒœ === 'ì§€ê°') {
                        dayCell.classList.add('late');
                        lateCount++;
                    } else if (record.ì¶œì„ìƒíƒœ === 'ê²°ì„') {
                        dayCell.classList.add('absent');
                        absentCount++;
                    }

                    dayCell.addEventListener('mouseover', () => {
                        hoverInfo.textContent = `${record.ì¶œì„ì¼}: ${record.ì¶œì„ìƒíƒœ} ${record.ì‚¬ìœ  ? `- ${record.ì‚¬ìœ }` : ''}`;
                    });

                    dayCell.addEventListener('mouseleave', () => {
                        hoverInfo.textContent = '';
                    });
                }

                calendar.appendChild(dayCell);
            }

            monthSummary.innerHTML = `
                ì´ ì¶œì„ì¼ìˆ˜: ${totalDays}ì¼<br>
                ì¶œì„: ${attendCount}ì¼ | ì§€ê°: ${lateCount}ì¼ | ê²°ì„: ${absentCount}ì¼
            `;
        }

function handleSelectionChange() {
    const studentId = studentSelect.value;
    const [year, month] = monthSelect.value.split('-');

    console.log(`ğŸ“£ ì„ íƒí•œ í•™ìƒ ID: ${studentId}, ì„ íƒí•œ ì›”: ${year}-${month}`);

    if (studentId && year && month) {
        loadAttendance(studentId, year, month);
    } else {
        console.warn('âš ï¸ í•™ìƒID, ì—°ë„, ì›”ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }
}

        monthSelect.addEventListener('change', handleSelectionChange);
        studentSelect.addEventListener('change', handleSelectionChange);

        // ì´ˆê¸°í™”
        monthSelect.value = new Date().toISOString().slice(0, 7);
        loadStudents();
    </script>
</body>
</html>
