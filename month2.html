<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¥ìŠ¤ ì¼ì‚°êµìœ¡ì› ì¶œì„</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
    <style>
        body {
            text-align: center;
        }

        .calendar-container {
            max-width: 400px;
            margin: auto;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .day,
        .weekday {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
            font-size: 14px;
        }

        .weekday {
            font-weight: bold;
            background: #f0f0f0;
        }

        .day {
            cursor: pointer;
            position: relative;
        }

        .day:hover {
            background-color: #f0f0f0;
        }

        .day[data-status="ì¶œì„"] {
            background-color: lightgreen;
        }

        .day[data-status="ì§€ê°"] {
            background-color: orange;
        }

        .day[data-status="ê²°ì„"] {
            background-color: lightcoral;
        }

        .tooltip {
            visibility: hidden;
            background-color: black;
            color: #fff;
            text-align: center;
            border-radius: 5px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
        }

        .day:hover .tooltip {
            visibility: visible;
        }

        .summary {
            margin-top: 20px;
        }
    </style>
</head>

<body>

    <h2>ë§¥ìŠ¤ì²´ëŒ€ì…ì‹œ ì¼ì‚°êµìœ¡ì› í•™ìƒë³„ ì¶œê²°í˜„í™©</h2>

    <!-- í•™ìƒ ì„ íƒ -->
    <label>í•™ìƒ ì„ íƒ:
        <select id="studentSelect">
            <option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>
        </select>
    </label>

    <!-- ì›” ì„ íƒ -->
    <label>ì›” ì„ íƒ:
        <input type="month" id="monthPicker">
    </label>

    <div class="calendar-container">
        <div class="calendar" id="calendar">
            <div class="weekday">ì¼</div>
            <div class="weekday">ì›”</div>
            <div class="weekday">í™”</div>
            <div class="weekday">ìˆ˜</div>
            <div class="weekday">ëª©</div>
            <div class="weekday">ê¸ˆ</div>
            <div class="weekday">í† </div>
        </div>
    </div>

    <div class="summary" id="summary">
        <p>ì´ ì¶œì„í•´ì•¼ í•  ì¼ìˆ˜: 0ì¼</p>
        <p>ì¶œì„: 0ì¼, ì§€ê°: 0ì¼, ê²°ì„: 0ì¼</p>
    </div>

    <script>
        const API_BASE = "https://supermax.kr";
        const calendar = document.getElementById("calendar");
        const monthPicker = document.getElementById("monthPicker");
        const studentSelect = document.getElementById("studentSelect");
        const summary = document.getElementById("summary");

        // í˜„ì¬ ì›” ì„¤ì •
        const today = new Date();
        monthPicker.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;

        // í•™ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadStudents() {
    const res = await fetch(`${API_BASE}/adminstudents`);
    const students = await res.json();

    // ì´ë¦„ ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬
    students.sort((a, b) => a.ì´ë¦„.localeCompare(b.ì´ë¦„, 'ko-KR'));

    studentSelect.innerHTML = `<option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>` + students.map(s => `<option value="${s.id}">${s.ì´ë¦„} (${s.í•™êµ})</option>`).join("");
}


        // í•™ìƒ, ì›” ë³€ê²½ ì‹œ ì¶œì„ ë°ì´í„° ë¡œë“œ
        studentSelect.addEventListener("change", loadAttendance);
        monthPicker.addEventListener("change", loadAttendance);

        async function loadAttendance() {
            const studentId = studentSelect.value;
            if (!studentId) {
                calendar.innerHTML = `<div class="weekday">ì¼</div><div class="weekday">ì›”</div><div class="weekday">í™”</div><div class="weekday">ìˆ˜</div><div class="weekday">ëª©</div><div class="weekday">ê¸ˆ</div><div class="weekday">í† </div>`;
                summary.innerHTML = `<p>ì´ ì¶œì„í•´ì•¼ í•  ì¼ìˆ˜: 0ì¼</p><p>ì¶œì„: 0ì¼, ì§€ê°: 0ì¼, ê²°ì„: 0ì¼</p>`;
                return;
            }

            const [year, month] = monthPicker.value.split("-");

            try {
                const res = await fetch(`${API_BASE}/attendancemonthstudent?year=${year}&month=${month}&studentId=${studentId}`);
                const attendanceData = await res.json();

                renderCalendar(year, month, attendanceData);
                updateMonthlySummary(attendanceData);
            } catch (error) {
                console.error(`âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (${studentId}):`, error);
            }
        }

        // ë‹¬ë ¥ ë Œë”ë§
        function renderCalendar(year, month, attendanceData) {
            calendar.innerHTML = `
                <div class="weekday">ì¼</div>
                <div class="weekday">ì›”</div>
                <div class="weekday">í™”</div>
                <div class="weekday">ìˆ˜</div>
                <div class="weekday">ëª©</div>
                <div class="weekday">ê¸ˆ</div>
                <div class="weekday">í† </div>
            `;

            const firstDay = new Date(year, month - 1, 1).getDay();
            const lastDate = new Date(year, month, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                calendar.innerHTML += `<div></div>`;
            }

for (let date = 1; date <= lastDate; date++) {
    const fullDate = `${year}-${String(month).padStart(2, '0')}-${String(date).padStart(2, '0')}`;

    const attendanceRecord = attendanceData.find(d => {
        const recordDateUTC = new Date(d.ì¶œì„ì¼);
        const recordDateKST = new Date(recordDateUTC.getTime() + (9 * 60 * 60 * 1000)); // KST ë³€í™˜
        const recordDateStr = recordDateKST.toISOString().split('T')[0];

        console.log(`ğŸ” ë¹„êµ ì¤‘ - ìº˜ë¦°ë”: ${fullDate}, ê¸°ë¡(KST ë³€í™˜): ${recordDateStr}`);
        return recordDateStr === fullDate;
    });

    const dayCell = document.createElement('div');
    dayCell.classList.add('day');
    dayCell.textContent = date;

    if (attendanceRecord) {
        console.log(`âœ… ê¸°ë¡ ìˆìŒ - ë‚ ì§œ: ${fullDate}, ìƒíƒœ: ${attendanceRecord.ì¶œì„ìƒíƒœ}, ì‚¬ìœ : ${attendanceRecord.ì‚¬ìœ }`);
        dayCell.dataset.status = attendanceRecord.ì¶œì„ìƒíƒœ;
        if (attendanceRecord.ì‚¬ìœ ) {
            const tooltip = document.createElement('div');
            tooltip.classList.add('tooltip');
            tooltip.textContent = `ì‚¬ìœ : ${attendanceRecord.ì‚¬ìœ }`;
            dayCell.appendChild(tooltip);
        }
    } else {
        console.log(`âŒ ê¸°ë¡ ì—†ìŒ - ë‚ ì§œ: ${fullDate}`);
    }

    calendar.appendChild(dayCell);
}


        }

        function updateMonthlySummary(attendanceData) {
            const ì¶œì„ì¼ìˆ˜ = attendanceData.filter(d => d.ì¶œì„ìƒíƒœ === 'ì¶œì„').length;
            const ì§€ê°ì¼ìˆ˜ = attendanceData.filter(d => d.ì¶œì„ìƒíƒœ === 'ì§€ê°').length;
            const ê²°ì„ì¼ìˆ˜ = attendanceData.filter(d => d.ì¶œì„ìƒíƒœ === 'ê²°ì„').length;

            summary.innerHTML = `
                <p>ì´ ì¶œì„í•´ì•¼ í•  ì¼ìˆ˜: ${attendanceData.length}ì¼</p>
                <p>ì¶œì„: ${ì¶œì„ì¼ìˆ˜}ì¼, ì§€ê°: ${ì§€ê°ì¼ìˆ˜}ì¼, ê²°ì„: ${ê²°ì„ì¼ìˆ˜}ì¼</p>
            `;
        }

        loadStudents();
    </script>

</body>

</html>
