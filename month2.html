<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 월별 출석현황</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
    <style>
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .day, .weekday {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .weekday {
            font-weight: bold;
            background: #f0f0f0;
        }
        .day.attend { background-color: #d4edda; } /* 출석 */
        .day.late { background-color: #fff3cd; }    /* 지각 */
        .day.absent { background-color: #f8d7da; }  /* 결석 */
        .day:hover { cursor: pointer; background-color: #f1f1f1; }
        .summary { margin-top: 10px; font-size: 14px; }
    </style>
</head>
<body>

    <h2>학생 월별 출석현황</h2>

    <label for="studentSelect">학생 선택:</label>
    <select id="studentSelect"></select>

    <label for="monthSelect">월 선택:</label>
    <input type="month" id="monthSelect">

    <div class="calendar" id="calendar"></div>

    <div id="hoverInfo" class="summary"></div>
    <div id="monthSummary" class="summary"></div>

    <script>
        const API_BASE = "https://supermax.kr";

        const studentSelect = document.getElementById("studentSelect");
        const monthSelect = document.getElementById("monthSelect");
        const calendar = document.getElementById("calendar");
        const hoverInfo = document.getElementById("hoverInfo");
        const monthSummary = document.getElementById("monthSummary");

        async function loadStudents() {
            const res = await fetch(`${API_BASE}/adminstudents`);
            const students = await res.json();

            studentSelect.innerHTML = `<option value="">학생 선택</option>`;
            students.forEach(student => {
                const option = document.createElement("option");
                option.value = student.id;
                option.textContent = `${student.이름} (${student.학교}, ${student.학년}학년)`;
                studentSelect.appendChild(option);
            });
        }

        async function loadAttendance(studentId, year, month) {
            const res = await fetch(`${API_BASE}/attendancemonthstudent?year=${year}&month=${month}&studentId=${studentId}`);
            const attendanceData = await res.json();
            renderCalendar(year, month, attendanceData);
        }

        function renderCalendar(year, month, attendanceData) {
            calendar.innerHTML = '';

            const firstDay = new Date(year, month - 1, 1).getDay();
            const lastDate = new Date(year, month, 0).getDate();

            // 요일 헤더 추가
            ['일', '월', '화', '수', '목', '금', '토'].forEach(day => {
                const div = document.createElement('div');
                div.className = 'weekday';
                div.textContent = day;
                calendar.appendChild(div);
            });

            // 빈칸 채우기 (첫째 날 위치 맞추기)
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                calendar.appendChild(emptyCell);
            }

            let attendCount = 0, lateCount = 0, absentCount = 0, totalDays = 0;

            for (let date = 1; date <= lastDate; date++) {
                const fullDate = `${year}-${String(month).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                const record = attendanceData.find(r => r.출석일 === fullDate);

                const dayCell = document.createElement('div');
                dayCell.classList.add('day');
                dayCell.textContent = date;

                if (record) {
                    totalDays++;
                    if (record.출석상태 === '출석') {
                        dayCell.classList.add('attend');
                        attendCount++;
                    } else if (record.출석상태 === '지각') {
                        dayCell.classList.add('late');
                        lateCount++;
                    } else if (record.출석상태 === '결석') {
                        dayCell.classList.add('absent');
                        absentCount++;
                    }

                    dayCell.addEventListener('mouseover', () => {
                        hoverInfo.textContent = `${record.출석일}: ${record.출석상태} ${record.사유 ? `- ${record.사유}` : ''}`;
                    });

                    dayCell.addEventListener('mouseleave', () => {
                        hoverInfo.textContent = '';
                    });
                }

                calendar.appendChild(dayCell);
            }

            monthSummary.innerHTML = `
                총 출석일수: ${totalDays}일<br>
                출석: ${attendCount}일 | 지각: ${lateCount}일 | 결석: ${absentCount}일
            `;
        }

        function handleSelectionChange() {
            const studentId = studentSelect.value;
            const [year, month] = monthSelect.value.split('-');
            if (studentId && year && month) {
                loadAttendance(studentId, year, month);
            }
        }

        monthSelect.addEventListener('change', handleSelectionChange);
        studentSelect.addEventListener('change', handleSelectionChange);

        // 초기화
        monthSelect.value = new Date().toISOString().slice(0, 7);
        loadStudents();
    </script>
</body>
</html>
