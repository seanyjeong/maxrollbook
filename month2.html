<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 출석 달력</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
    <style>
        body { text-align: center; }
        .calendar-container { max-width: 400px; margin: auto; }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
        .day, .weekday { padding: 10px; border: 1px solid #ddd; text-align: center; font-size: 14px; position: relative; }
        .weekday { font-weight: bold; background: #f0f0f0; }
        .day { cursor: pointer; }
        .day:hover { background-color: #f0f0f0; }
        .attended { background-color: #28a745; color: white; }
        .late { background-color: #ffc107; color: black; }
        .absent { background-color: #dc3545; color: white; }
        .tooltip { display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background-color: black; color: white; padding: 5px; border-radius: 4px; white-space: nowrap; z-index: 10; }
        .day:hover .tooltip { display: block; }
        .summary { margin-top: 20px; font-size: 16px; }
    </style>
</head>
<body>
    <h2>학생 출석 달력</h2>
    <label for="studentSelect">학생 선택: </label>
    <select id="studentSelect"></select>
    <br>
    <label>월 선택:
        <input type="month" id="monthPicker">
    </label>
    
    <div class="calendar-container">
        <div class="calendar" id="calendar"></div>
    </div>

    <div class="summary" id="attendanceSummary"></div>

    <script>
        const API_BASE = "https://supermax.kr";
        const calendar = document.getElementById("calendar");
        const monthPicker = document.getElementById("monthPicker");
        const studentSelect = document.getElementById("studentSelect");
        const attendanceSummary = document.getElementById("attendanceSummary");

        const today = new Date();
        monthPicker.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;

        async function loadStudents() {
            const response = await fetch(`${API_BASE}/adminstudents`);
            const students = await response.json();
            studentSelect.innerHTML = students.map(s => `<option value="${s.id}">${s.이름}</option>`).join("");
            loadAttendanceData();
        }

        async function loadAttendanceData() {
            const studentId = studentSelect.value;
            const [year, month] = monthPicker.value.split("-");

            const response = await fetch(`${API_BASE}/attendancemonthstudent?year=${year}&month=${month}&studentId=${studentId}`);
            const attendanceData = await response.json();

            renderCalendar(year, month, attendanceData);
        }

        function renderCalendar(year, month, attendanceData) {
            calendar.innerHTML = `
                <div class="weekday">일</div><div class="weekday">월</div><div class="weekday">화</div>
                <div class="weekday">수</div><div class="weekday">목</div><div class="weekday">금</div><div class="weekday">토</div>
            `;

            const firstDay = new Date(year, month - 1, 1).getDay();
            const lastDate = new Date(year, month, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement("div");
                calendar.appendChild(emptyCell);
            }

            let attended = 0, late = 0, absent = 0, totalDays = 0;

            for (let date = 1; date <= lastDate; date++) {
                const dayElement = document.createElement("div");
                dayElement.classList.add("day");
                dayElement.textContent = date;

                const fullDate = `${year}-${String(month).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                const record = attendanceData.find(r => r.출석일 === fullDate);

                if (record) {
                    totalDays++;
                    let statusClass = "";
                    if (record.출석상태 === "출석") {
                        statusClass = "attended";
                        attended++;
                    } else if (record.출석상태 === "지각") {
                        statusClass = "late";
                        late++;
                    } else if (record.출석상태 === "결석") {
                        statusClass = "absent";
                        absent++;
                    }
                    if (statusClass) dayElement.classList.add(statusClass);

                    if (record.사유) {
                        const tooltip = document.createElement("div");
                        tooltip.className = "tooltip";
                        tooltip.textContent = `사유: ${record.사유}`;
                        dayElement.appendChild(tooltip);
                    }
                }

                calendar.appendChild(dayElement);
            }

            attendanceSummary.innerHTML = `
                총 출석 대상일: ${totalDays}일 | 출석: ${attended}일 | 지각: ${late}일 | 결석: ${absent}일
            `;
        }

        studentSelect.addEventListener("change", loadAttendanceData);
        monthPicker.addEventListener("change", loadAttendanceData);

        loadStudents();
    </script>
</body>
</html>
