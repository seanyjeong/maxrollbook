<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>출근 현황 (달력)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
    <style>
        body { font-size: 16px; text-align: center; }
        select, button { font-size: 16px; padding: 8px; margin: 5px; }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
        .day { padding: 10px; border: 1px solid #ddd; border-radius: 5px; min-height: 50px; }
        .day.work { background-color: #d4edda; }
        .day.late { background-color: #fff3cd; }
        .day.off { background-color: #f8d7da; }
        .day-header { font-weight: bold; background-color: #e9ecef; }
    </style>
</head>
<body>
    <h1>출근 현황 (달력)</h1>
    <div>
        <select id="teacherSelect"></select>
        <input type="month" id="monthInput">
        <button onclick="fetchAttendance()">조회</button>
    </div>
    <div class="calendar" id="calendar"></div>
    <p id="summary">출근일수: -일</p>

    <script>
        async function loadTeachers() {
            const response = await fetch('https://supermax.kr/teachers');
            const teachers = await response.json();
            console.log('강사 목록:', teachers);
            const select = document.getElementById('teacherSelect');

            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.id;
                option.textContent = `${teacher.이름} (${teacher.직급 || '직급 없음'})`;
                select.appendChild(option);
            });
        }

        async function fetchAttendance() {
            const teacherId = document.getElementById('teacherSelect').value;
            const month = document.getElementById('monthInput').value;
            if (!teacherId || !month) return alert('강사와 월을 선택하세요');

            const year = month.split('-')[0];
            const monthNumber = month.split('-')[1];

            console.log(`조회 요청: 강사ID=${teacherId}, year=${year}, month=${monthNumber}`);

            const response = await fetch(`https://supermax.kr/attendanceteacher?id=${teacherId}&year=${year}&month=${monthNumber}`);
            const records = await response.json();

            console.log('조회된 출근 기록:', records);

            const firstDay = new Date(year, monthNumber - 1, 1).getDay();
            const lastDate = new Date(year, monthNumber, 0).getDate();

            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';

            const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
            dayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'day day-header';
                header.textContent = day;
                calendar.appendChild(header);
            });

            for (let i = 0; i < firstDay; i++) {
                calendar.innerHTML += '<div class="day"></div>';
            }

            let workDays = 0;

            for (let day = 1; day <= lastDate; day++) {
                const dateString = `${year}-${monthNumber}-${String(day).padStart(2, '0')}`;
                const dateObject = new Date(dateString);
                const dayOfWeek = dateObject.getDay();
                const 요일칼럼 = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'][dayOfWeek];

                const record = records.find(r => r.출근일.startsWith(dateString));
                let 상태숫자 = record ? record[요일칼럼] : 0;

                console.log(`날짜: ${dateString}, 요일: ${요일칼럼}, 상태: ${상태숫자}`);

                let className = 'day';
                let displayText = day;

                if (상태숫자 === 1) {
                    className += ' work';
                    workDays++;
                } else if (상태숫자 === 2) {
                    className += ' late';
                    workDays++;
                } else {
                    className += ' off';
                }

                calendar.innerHTML += `<div class="${className}">${displayText}</div>`;
            }

            document.getElementById('summary').textContent = `출근일수: ${workDays}일`;
        }

        loadTeachers();
    </script>
</body>
</html>
